<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DSP é¡¹ç›®4 - DTWå­¤ç«‹è¯è¯­éŸ³è¯†åˆ«ä»£ç æ¨¡æ¿</title>
    <style>
        body { font-family: 'Segoe UI', Consolas, 'Microsoft YaHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        .control-panel { position: sticky; top: 0; z-index: 100; background: white; padding: 15px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        .control-btn { background: #667eea; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .control-btn:hover { background: #5a67d8; }
        .control-btn.secondary { background: #6c757d; }
        .file-block { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .file-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .file-header:hover { opacity: 0.9; }
        .file-header.completed { background: linear-gradient(135deg, #48bb78 0%, #38a169 100%); }
        .file-title { font-weight: bold; display: flex; align-items: center; }
        .arrow-icon { display: inline-block; margin-right: 10px; transition: transform 0.3s; }
        .file-block.collapsed .arrow-icon { transform: rotate(-90deg); }
        .file-content { display: block; }
        .file-block.collapsed .file-content { display: none; }
        .copy-btn { background: #48bb78; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .copy-btn:hover { background: #38a169; }
        pre { margin: 0; padding: 20px; overflow-x: auto; line-height: 1.8; font-size: 13px; background: #f8f9fa; border-top: 1px solid #e9ecef; }
        .keyword { color: #0000ff; font-weight: bold; }
        .comment { color: #228b22; font-style: italic; }
        .string { color: #a020f0; }
        .number { color: #ff0000; }
        .todo { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 3px; border: 1px solid #ffeeba; font-weight: bold; }
        .info-banner { background: linear-gradient(135deg, #e7f3ff 0%, #f0f7ff 100%); border-left: 4px solid #667eea; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .warning-banner { background: linear-gradient(135deg, #fff3cd 0%, #fffdf7 100%); border-left: 4px solid #ed8936; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .success-banner { background: linear-gradient(135deg, #f0fff4 0%, #f7fafc 100%); border-left: 4px solid #48bb78; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        code { background: #edf2f7; padding: 2px 6px; border-radius: 3px; color: #667eea; font-size: 0.95em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <h2 style="margin:0; color:#667eea;">ğŸ¤ DSP é¡¹ç›®4 - DTWå­¤ç«‹è¯è¯­éŸ³è¯†åˆ«ä»£ç æ¨¡æ¿</h2>
            <div>
                <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•å¼€</button>
                <button class="control-btn secondary" onclick="collapseAll()">å…¨éƒ¨æŠ˜å </button>
            </div>
        </div>

        <div class="info-banner">
            <strong>ğŸ“Œ é¡¹ç›®è¯´æ˜ï¼š</strong>
            <ul style="margin:5px 0 0 20px; padding:0; line-height:1.8;">
                <li>æœ¬é¡¹ç›®å®ç°åŸºäº<strong>åŠ¨æ€æ—¶é—´è§„æ•´ï¼ˆDTWï¼‰</strong>çš„å­¤ç«‹è¯è¯­éŸ³è¯†åˆ«ç³»ç»Ÿ</li>
                <li>ä»£ç ä¸­ <code>?</code> æ ‡è®°å¤„éœ€è¦å¡«å†™åˆé€‚çš„ä»£ç </li>
                <li>å®Œæˆex1-ex4åï¼Œè¿è¡Œ <code>train_template.m</code> ç”Ÿæˆæ¨¡æ¿ï¼Œå†è¿è¡Œ <code>ex0_all.m</code> æµ‹è¯•</li>
            </ul>
        </div>

        <div class="warning-banner">
            <strong>âš ï¸ æäº¤æ¸…å•ï¼š</strong>ex1_preemphasis.mã€ex2_enframe.mã€ex3_mfcc.mã€ex4_dtw.m
        </div>

        <div class="success-banner">
            <strong>âœ… å®éªŒæµç¨‹ï¼š</strong>
            <ol style="margin:5px 0 0 20px; padding:0; line-height:1.8;">
                <li>æŒ‰é¡ºåºå®Œæˆ ex1-ex4ï¼Œå¡«å†™ <code>?</code> å¤„çš„ä»£ç </li>
                <li>è¿è¡Œ <code>train_template.m</code> ç”Ÿæˆ template.mat</li>
                <li>è¿è¡Œ <code>ex0_all.m</code> æµ‹è¯•ï¼ˆå…ˆç”¨testç›®å½•ï¼Œå†ç”¨trainç›®å½•å¯¹æ¯”ï¼‰</li>
                <li>è¿è¡Œ <code>test_Project4.p</code> æ£€æŸ¥ä»£ç ï¼Œç”ŸæˆåŠ å¯†æˆç»©</li>
            </ol>
        </div>

        <!-- train_template -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ train_template.mï¼ˆæ¨¡æ¿è®­ç»ƒ - å¿…é¡»å…ˆè¿è¡Œï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code_train')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code_train"><span class="comment">%% train_template.m - ä»è®­ç»ƒéŸ³é¢‘ç”ŸæˆDTWæ¨¡æ¿åº“</span>
<span class="comment">% åŠŸèƒ½: ä» train/ ç›®å½•è¯»å–éŸ³é¢‘ï¼Œä½¿ç”¨ä¸­å¿ƒæ ·æœ¬æ³•ç”Ÿæˆæ¨¡æ¿</span>
<span class="comment">% ä½¿ç”¨: >> train_template</span>

<span class="keyword">clear</span>; <span class="keyword">clc</span>; <span class="keyword">close</span> <span class="keyword">all</span>;

train_dir = <span class="string">'train'</span>;
output_file = <span class="string">'template.mat'</span>;
target_fs = <span class="number">16000</span>;

params = <span class="keyword">struct</span>();
params.frame_len_ms = <span class="number">25</span>;
params.frame_shift_ms = <span class="number">10</span>;
params.pre_emphasis = <span class="number">0.97</span>;
params.nfft = <span class="number">2048</span>;
params.num_filters = <span class="number">32</span>;
params.num_ceps = <span class="number">12</span>;
params.lifter_coef = <span class="number">22</span>;
params.delta_N = <span class="number">2</span>;

fprintf(<span class="string">'DTWæ¨¡æ¿è®­ç»ƒç¨‹åº\n'</span>);
wav_files = dir(fullfile(train_dir, <span class="string">'*.wav'</span>));
digit_names = {<span class="string">'zero'</span>,<span class="string">'one'</span>,<span class="string">'two'</span>,<span class="string">'three'</span>,<span class="string">'four'</span>,<span class="string">'five'</span>,<span class="string">'six'</span>,<span class="string">'seven'</span>,<span class="string">'eight'</span>,<span class="string">'nine'</span>};

<span class="comment">% æŒ‰æ•°å­—åˆ†ç»„</span>
digit_files = cell(<span class="number">10</span>, <span class="number">1</span>);
<span class="keyword">for</span> i = <span class="number">1</span>:length(wav_files)
    filename = wav_files(i).name;
    label = extract_digit_label(filename, digit_names);
    <span class="keyword">if</span> label >= <span class="number">0</span> && label <= <span class="number">9</span>
        digit_files{label+<span class="number">1</span>} = [digit_files{label+<span class="number">1</span>}; {filename}];
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% æå–MFCC</span>
all_features = cell(<span class="number">10</span>, <span class="number">1</span>);
<span class="keyword">for</span> digit = <span class="number">0</span>:<span class="number">9</span>
    files = digit_files{digit+<span class="number">1</span>};
    features = {};
    <span class="keyword">for</span> k = <span class="number">1</span>:length(files)
        [audio, fs] = audioread(fullfile(train_dir, files{k}));
        <span class="keyword">if</span> size(audio,<span class="number">2</span>)><span class="number">1</span>, audio=audio(:,<span class="number">1</span>); <span class="keyword">end</span>
        <span class="keyword">if</span> fs~=target_fs, audio=resample(audio,target_fs,fs); <span class="keyword">end</span>
        audio_vad = ex6_vad(audio, target_fs);
        <span class="keyword">if</span> length(audio_vad) >= target_fs*<span class="number">0.05</span>
            features{end+<span class="number">1</span>} = ex3_mfcc(audio_vad, target_fs, params);
        <span class="keyword">end</span>
    <span class="keyword">end</span>
    all_features{digit+<span class="number">1</span>} = features;
    fprintf(<span class="string">'æ•°å­—%d: %dæ ·æœ¬\n'</span>, digit, length(features));
<span class="keyword">end</span>

<span class="comment">% ä¸­å¿ƒæ ·æœ¬æ³•é€‰æ‹©æ¨¡æ¿</span>
template = cell(<span class="number">1</span>, <span class="number">10</span>);
<span class="keyword">for</span> digit = <span class="number">0</span>:<span class="number">9</span>
    samples = all_features{digit+<span class="number">1</span>};
    <span class="keyword">if</span> length(samples)==<span class="number">1</span>
        template{digit+<span class="number">1</span>} = samples{<span class="number">1</span>};
    <span class="keyword">else</span>
        dist_sum = zeros(length(samples),<span class="number">1</span>);
        <span class="keyword">for</span> i=<span class="number">1</span>:length(samples)
            <span class="keyword">for</span> j=<span class="number">1</span>:length(samples)
                <span class="keyword">if</span> i~=j, dist_sum(i)=dist_sum(i)+ex4_dtw(samples{i},samples{j},<span class="keyword">true</span>); <span class="keyword">end</span>
            <span class="keyword">end</span>
        <span class="keyword">end</span>
        [~,idx] = min(dist_sum);
        template{digit+<span class="number">1</span>} = samples{idx};
    <span class="keyword">end</span>
<span class="keyword">end</span>

save(output_file, <span class="string">'template'</span>);
fprintf(<span class="string">'æ¨¡æ¿å·²ä¿å­˜: %s\n'</span>, output_file);

<span class="keyword">function</span> label = extract_digit_label(filename, digit_names)
    [~,name,~] = fileparts(filename);
    name_lower = lower(name);
    <span class="keyword">for</span> i=<span class="number">1</span>:<span class="number">10</span>
        <span class="keyword">if</span> contains(name_lower, digit_names{i}), label=i-<span class="number">1</span>; <span class="keyword">return</span>; <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> ~isempty(name)&&name(<span class="number">1</span>)>=<span class="string">'0'</span>&&name(<span class="number">1</span>)<=<span class="string">'9'</span>, label=str2double(name(<span class="number">1</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
    label = -<span class="number">1</span>;
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex0 ä¸»å‡½æ•° -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex0_all.mï¼ˆä¸»ç¨‹åº - æ— éœ€ä¿®æ”¹ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code0')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code0"><span class="comment">%% ex0_all.m - DTWå­¤ç«‹è¯è¯­éŸ³è¯†åˆ«ä¸»ç¨‹åº</span>
<span class="comment">% ä½¿ç”¨æ–¹æ³•: å…ˆè¿è¡Œtrain_template.mï¼Œå†è¿è¡Œæ­¤è„šæœ¬</span>
<span class="comment">% å¯ä¿®æ”¹audio_dirä¸º'test'æˆ–'train'è¿›è¡Œå¯¹æ¯”æµ‹è¯•</span>

<span class="keyword">clear</span>; <span class="keyword">clc</span>; <span class="keyword">close</span> <span class="keyword">all</span>;

audio_dir = <span class="string">'test'</span>;   <span class="comment">% å¯æ”¹ä¸º'train'å¯¹æ¯”</span>
target_fs = <span class="number">16000</span>;

params = <span class="keyword">struct</span>();
params.frame_len_ms = <span class="number">25</span>;
params.frame_shift_ms = <span class="number">10</span>;
params.pre_emphasis = <span class="number">0.97</span>;
params.nfft = <span class="number">2048</span>;
params.num_filters = <span class="number">32</span>;
params.num_ceps = <span class="number">12</span>;
params.lifter_coef = <span class="number">22</span>;
params.delta_N = <span class="number">2</span>;

fprintf(<span class="string">'DTWå­¤ç«‹è¯è¯­éŸ³è¯†åˆ«\n'</span>);
fprintf(<span class="string">'æµ‹è¯•ç›®å½•: %s\n'</span>, audio_dir);

<span class="keyword">if</span> ~exist(<span class="string">'template.mat'</span>, <span class="string">'file'</span>)
    error(<span class="string">'æ‰¾ä¸åˆ°template.matï¼è¯·å…ˆè¿è¡Œtrain_template.m'</span>);
<span class="keyword">end</span>
load(<span class="string">'template.mat'</span>, <span class="string">'template'</span>);
templates = template;

wav_files = dir(fullfile(audio_dir, <span class="string">'*.wav'</span>));
correct = <span class="number">0</span>; total = <span class="number">0</span>;

<span class="keyword">for</span> i = <span class="number">1</span>:length(wav_files)
    [audio, fs] = audioread(fullfile(audio_dir, wav_files(i).name));
    <span class="keyword">if</span> size(audio,<span class="number">2</span>)><span class="number">1</span>, audio=audio(:,<span class="number">1</span>); <span class="keyword">end</span>
    <span class="keyword">if</span> fs~=target_fs, audio=resample(audio,target_fs,fs); fs=target_fs; <span class="keyword">end</span>
    
    audio_vad = ex6_vad(audio, fs);
    <span class="keyword">if</span> length(audio_vad) < fs*<span class="number">0.05</span>, <span class="keyword">continue</span>; <span class="keyword">end</span>
    
    test_feat = ex3_mfcc(audio_vad, fs, params);
    [result, scores, ~] = ex5_recognize(test_feat, templates);
    
    true_label = extract_label(wav_files(i).name);
    <span class="keyword">if</span> true_label >= <span class="number">0</span>
        total = total + <span class="number">1</span>;
        <span class="keyword">if</span> result == true_label, correct = correct + <span class="number">1</span>; <span class="keyword">end</span>
        fprintf(<span class="string">'%s: çœŸå®=%d è¯†åˆ«=%d %s\n'</span>, wav_files(i).name, true_label, result, ...
            iif(result==true_label, <span class="string">'âœ“'</span>, <span class="string">'âœ—'</span>));
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">if</span> total > <span class="number">0</span>
    fprintf(<span class="string">'\nè¯†åˆ«ç‡: %.1f%% (%d/%d)\n'</span>, correct/total*<span class="number">100</span>, correct, total);
<span class="keyword">end</span>

<span class="keyword">function</span> label = extract_label(filename)
    [~,name,~] = fileparts(filename);
    digit_names = {<span class="string">'zero'</span>,<span class="string">'one'</span>,<span class="string">'two'</span>,<span class="string">'three'</span>,<span class="string">'four'</span>,<span class="string">'five'</span>,<span class="string">'six'</span>,<span class="string">'seven'</span>,<span class="string">'eight'</span>,<span class="string">'nine'</span>};
    <span class="keyword">for</span> i=<span class="number">1</span>:<span class="number">10</span>
        <span class="keyword">if</span> contains(lower(name), digit_names{i}), label=i-<span class="number">1</span>; <span class="keyword">return</span>; <span class="keyword">end</span>
    <span class="keyword">end</span>
    <span class="keyword">if</span> ~isempty(name)&&name(<span class="number">1</span>)>=<span class="string">'0'</span>&&name(<span class="number">1</span>)<=<span class="string">'9'</span>, label=str2double(name(<span class="number">1</span>)); <span class="keyword">return</span>; <span class="keyword">end</span>
    label = -<span class="number">1</span>;
<span class="keyword">end</span>

<span class="keyword">function</span> r = iif(cond, t, f)
    <span class="keyword">if</span> cond, r=t; <span class="keyword">else</span>, r=f; <span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex1 é¢„åŠ é‡ -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex1_preemphasis.mï¼ˆé¢„åŠ é‡æ»¤æ³¢ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code1')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code1"><span class="keyword">function</span> y = ex1_preemphasis(x, alpha)
<span class="comment">%EX1_PREEMPHASIS é¢„åŠ é‡æ»¤æ³¢</span>
<span class="comment">%   y = ex1_preemphasis(x, alpha)</span>
<span class="comment">%   å…¬å¼: y[n] = x[n] - alpha * x[n-1]</span>

<span class="keyword">if</span> nargin < <span class="number">2</span>, alpha = <span class="number">0.97</span>; <span class="keyword">end</span>
x = x(:);

<span class="comment">% TODO: ä½¿ç”¨filterå‡½æ•°å®ç°ï¼Œb = [1, -alpha], a = 1</span>
y = filter(<span class="todo">?</span>, <span class="number">1</span>, x);

<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex2 åˆ†å¸§ -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex2_enframe.mï¼ˆä¿¡å·åˆ†å¸§ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code2')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code2"><span class="keyword">function</span> frames = ex2_enframe(x, frame_len, frame_shift)
<span class="comment">%EX2_ENFRAME å°†ä¿¡å·åˆ†å¸§</span>
<span class="comment">%   å¸§æ•° = floor((N - frame_len) / frame_shift) + 1</span>

x = x(:);
N = length(x);

<span class="comment">% TODO: è®¡ç®—å¸§æ•°</span>
num_frames = <span class="todo">?</span>;

<span class="keyword">if</span> num_frames < <span class="number">1</span>, error(<span class="string">'ä¿¡å·å¤ªçŸ­'</span>); <span class="keyword">end</span>

frames = zeros(frame_len, num_frames);
<span class="keyword">for</span> i = <span class="number">1</span>:num_frames
    <span class="comment">% TODO: è®¡ç®—ç¬¬iå¸§çš„èµ·å§‹ç´¢å¼•</span>
    start_idx = <span class="todo">?</span>;
    frames(:, i) = x(start_idx : start_idx + frame_len - <span class="number">1</span>);
<span class="keyword">end</span>

<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex3 MFCC -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex3_mfcc.mï¼ˆMFCCç‰¹å¾æå–ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code3')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code3"><span class="keyword">function</span> [mfcc_all, mfcc_base] = ex3_mfcc(x, fs, params)
<span class="comment">%EX3_MFCC è®¡ç®—MFCCç‰¹å¾ (å«Deltaå’ŒDelta-Delta)</span>
<span class="comment">%   è¾“å‡º: mfcc_all [36 x num_frames]</span>

<span class="keyword">if</span> nargin < <span class="number">3</span>, params = <span class="keyword">struct</span>(); <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'frame_len_ms'</span>), params.frame_len_ms = <span class="number">25</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'frame_shift_ms'</span>), params.frame_shift_ms = <span class="number">10</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'pre_emphasis'</span>), params.pre_emphasis = <span class="number">0.97</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'nfft'</span>), params.nfft = <span class="number">2048</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'num_filters'</span>), params.num_filters = <span class="number">32</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'num_ceps'</span>), params.num_ceps = <span class="number">12</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'lifter_coef'</span>), params.lifter_coef = <span class="number">22</span>; <span class="keyword">end</span>
<span class="keyword">if</span> ~isfield(params, <span class="string">'delta_N'</span>), params.delta_N = <span class="number">2</span>; <span class="keyword">end</span>

<span class="comment">% Step 1: é¢„åŠ é‡</span>
x_emph = ex1_preemphasis(x, params.pre_emphasis);

<span class="comment">% Step 2: åˆ†å¸§</span>
frame_len = round(params.frame_len_ms * fs / <span class="number">1000</span>);
frame_shift = round(params.frame_shift_ms * fs / <span class="number">1000</span>);
frames = ex2_enframe(x_emph, frame_len, frame_shift);
num_frames = size(frames, <span class="number">2</span>);

<span class="comment">% Step 3: åŠ çª—</span>
<span class="comment">% TODO: åˆ›å»ºæ±‰å®çª—</span>
win = <span class="todo">?</span>;
frames_win = <span class="todo">?</span>;

<span class="comment">% Step 4: FFT</span>
nfft = params.nfft;
<span class="comment">% TODO: è®¡ç®—FFTå’ŒåŠŸç‡è°±</span>
X = <span class="todo">?</span>;
pow_spec = <span class="todo">?</span>;

<span class="comment">% Step 5: Melæ»¤æ³¢å™¨ç»„</span>
mel_bank = create_mel_filterbank(fs, nfft, params.num_filters, <span class="number">0</span>, fs/<span class="number">2</span>);
mel_energy = mel_bank * pow_spec;
mel_energy = max(mel_energy, eps);

<span class="comment">% Step 6: å–å¯¹æ•°</span>
log_mel = log(mel_energy);

<span class="comment">% Step 7: DCT</span>
<span class="comment">% TODO: DCTå˜æ¢ï¼Œå–ç¬¬2åˆ°(num_ceps+1)é˜¶</span>
dct_coef = <span class="todo">?</span>;
mfcc_base = <span class="todo">?</span>;

<span class="comment">% Step 8: å‡å€’è°±</span>
L = params.lifter_coef;
n = (<span class="number">1</span>:params.num_ceps)';
lifter = <span class="number">1</span> + (L/<span class="number">2</span>) * sin(pi * n / L);
mfcc_base = mfcc_base .* repmat(lifter, <span class="number">1</span>, num_frames);

<span class="comment">% Step 9: Delta</span>
delta = compute_delta(mfcc_base, params.delta_N);
delta_delta = compute_delta(delta, params.delta_N);
mfcc_all = [mfcc_base; delta; delta_delta];
<span class="keyword">end</span>

<span class="keyword">function</span> mel_bank = create_mel_filterbank(fs, nfft, num_filters, low_freq, high_freq)
    hz2mel = @(f) <span class="number">2595</span> * log10(<span class="number">1</span> + f/<span class="number">700</span>);
    mel2hz = @(m) <span class="number">700</span> * (<span class="number">10</span>.^(m/<span class="number">2595</span>) - <span class="number">1</span>);
    mel_points = linspace(hz2mel(low_freq), hz2mel(high_freq), num_filters + <span class="number">2</span>);
    hz_points = mel2hz(mel_points);
    bin_points = floor(hz_points / fs * nfft) + <span class="number">1</span>;
    bin_points = min(max(bin_points, <span class="number">1</span>), nfft/<span class="number">2</span> + <span class="number">1</span>);
    mel_bank = zeros(num_filters, nfft/<span class="number">2</span> + <span class="number">1</span>);
    <span class="keyword">for</span> i = <span class="number">1</span>:num_filters
        left = bin_points(i); center = bin_points(i+<span class="number">1</span>); right = bin_points(i+<span class="number">2</span>);
        <span class="keyword">for</span> k = left:center
            <span class="keyword">if</span> center ~= left, mel_bank(i,k) = (k-left)/(center-left); <span class="keyword">end</span>
        <span class="keyword">end</span>
        <span class="keyword">for</span> k = center:right
            <span class="keyword">if</span> right ~= center, mel_bank(i,k) = (right-k)/(right-center); <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> delta = compute_delta(feat, N)
    [num_ceps, num_frames] = size(feat);
    delta = zeros(num_ceps, num_frames);
    denom = <span class="number">2</span> * sum((<span class="number">1</span>:N).^<span class="number">2</span>);
    <span class="keyword">for</span> t = <span class="number">1</span>:num_frames
        numerator = zeros(num_ceps, <span class="number">1</span>);
        <span class="keyword">for</span> n = <span class="number">1</span>:N
            numerator = numerator + n * (feat(:, min(t+n,num_frames)) - feat(:, max(t-n,<span class="number">1</span>)));
        <span class="keyword">end</span>
        delta(:, t) = numerator / denom;
    <span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex4 DTW -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex4_dtw.mï¼ˆDTWåŠ¨æ€è§„æ•´ï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code4')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code4"><span class="keyword">function</span> [dist, D, path] = ex4_dtw(template, test, normalize_flag)
<span class="comment">%EX4_DTW åŠ¨æ€æ—¶é—´è§„æ•´ç®—æ³•</span>
<span class="comment">%   é€’æ¨å…¬å¼: D(i,j) = d(i,j) + min{D(i-1,j), D(i,j-1), D(i-1,j-1)}</span>

<span class="keyword">if</span> nargin < <span class="number">3</span>, normalize_flag = <span class="keyword">true</span>; <span class="keyword">end</span>

[dim1, n] = size(template);
[dim2, m] = size(test);
<span class="keyword">if</span> dim1 ~= dim2, error(<span class="string">'ç‰¹å¾ç»´åº¦ä¸åŒ¹é…'</span>); <span class="keyword">end</span>

<span class="comment">% å‡å€¼å½’ä¸€åŒ–</span>
<span class="keyword">if</span> normalize_flag
    template = template - mean(template, <span class="number">2</span>);
    test = test - mean(test, <span class="number">2</span>);
<span class="keyword">end</span>

<span class="comment">% è®¡ç®—å±€éƒ¨è·ç¦»</span>
local_dist = zeros(n, m);
<span class="keyword">for</span> i = <span class="number">1</span>:n
    <span class="keyword">for</span> j = <span class="number">1</span>:m
        <span class="comment">% TODO: è®¡ç®—æ¬§æ°è·ç¦»</span>
        local_dist(i, j) = <span class="todo">?</span>;
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% åˆå§‹åŒ–ç´¯ç§¯è·ç¦»çŸ©é˜µ</span>
<span class="comment">% TODO: DçŸ©é˜µåˆå§‹åŒ–ä¸ºinfï¼Œå¤§å°(n+1)x(m+1)</span>
D = <span class="todo">?</span>;
<span class="comment">% TODO: è®¾ç½®D(1,1)=0</span>
<span class="todo">?</span>;

<span class="comment">% åŠ¨æ€è§„åˆ’</span>
<span class="keyword">for</span> i = <span class="number">1</span>:n
    <span class="keyword">for</span> j = <span class="number">1</span>:m
        cost = local_dist(i, j);
        <span class="comment">% TODO: è·å–ä¸‰ä¸ªæ–¹å‘çš„ç´¯ç§¯è·ç¦»</span>
        d1 = <span class="todo">?</span>;  <span class="comment">% D(i, j+1) ä¸Šæ–¹</span>
        d2 = <span class="todo">?</span>;  <span class="comment">% D(i+1, j) å·¦æ–¹</span>
        d3 = <span class="todo">?</span>;  <span class="comment">% D(i, j)   å¯¹è§’</span>
        <span class="comment">% TODO: é€’æ¨</span>
        D(i + <span class="number">1</span>, j + <span class="number">1</span>) = <span class="todo">?</span>;
    <span class="keyword">end</span>
<span class="keyword">end</span>

dist = D(n + <span class="number">1</span>, m + <span class="number">1</span>);
<span class="keyword">if</span> nargout >= <span class="number">3</span>, path = backtrack(D); <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="keyword">function</span> path = backtrack(D)
    [n_plus1, m_plus1] = size(D);
    path = zeros(n_plus1 + m_plus1, <span class="number">2</span>);
    k = <span class="number">0</span>; i = n_plus1-<span class="number">1</span>; j = m_plus1-<span class="number">1</span>;
    <span class="keyword">while</span> i > <span class="number">0</span> && j > <span class="number">0</span>
        k = k + <span class="number">1</span>; path(k, :) = [i, j];
        <span class="keyword">if</span> i == <span class="number">1</span> && j == <span class="number">1</span>, <span class="keyword">break</span>; <span class="keyword">end</span>
        candidates = [];
        <span class="keyword">if</span> i><span class="number">1</span>&&j><span class="number">1</span>, candidates = [candidates; i-<span class="number">1</span>,j-<span class="number">1</span>,D(i,j)]; <span class="keyword">end</span>
        <span class="keyword">if</span> i><span class="number">1</span>, candidates = [candidates; i-<span class="number">1</span>,j,D(i,j+<span class="number">1</span>)]; <span class="keyword">end</span>
        <span class="keyword">if</span> j><span class="number">1</span>, candidates = [candidates; i,j-<span class="number">1</span>,D(i+<span class="number">1</span>,j)]; <span class="keyword">end</span>
        <span class="keyword">if</span> isempty(candidates), <span class="keyword">break</span>; <span class="keyword">end</span>
        [~, idx] = min(candidates(:, <span class="number">3</span>));
        i = candidates(idx, <span class="number">1</span>); j = candidates(idx, <span class="number">2</span>);
    <span class="keyword">end</span>
    path = flipud(path(<span class="number">1</span>:k, :));
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex5 è¯†åˆ«å†³ç­– -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex5_recognize.mï¼ˆè¯†åˆ«å†³ç­– - å·²å®Œæˆï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code5')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code5"><span class="keyword">function</span> [result, scores, min_score] = ex5_recognize(test_feat, templates)
num_templates = length(templates);
scores = zeros(<span class="number">1</span>, num_templates);
<span class="keyword">for</span> i = <span class="number">1</span>:num_templates
    scores(i) = ex4_dtw(templates{i}, test_feat, <span class="keyword">true</span>);
<span class="keyword">end</span>
[min_score, min_idx] = min(scores);
result = min_idx - <span class="number">1</span>;
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex6 VAD -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title"><span class="arrow-icon">â–¼</span>ğŸ“„ ex6_vad.mï¼ˆç«¯ç‚¹æ£€æµ‹ - å·²å®Œæˆï¼‰</span>
                <button class="copy-btn" onclick="copyCode(event, 'code6')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code6"><span class="keyword">function</span> [y, start_idx, end_idx] = ex6_vad(x, fs)
x = x(:); N = length(x);
frame_len = round(<span class="number">0.025</span> * fs);
frame_shift = round(<span class="number">0.010</span> * fs);
thresh_high = <span class="number">0.15</span>; thresh_low = <span class="number">0.05</span>; margin = <span class="number">3</span>;

num_frames = floor((N - frame_len) / frame_shift) + <span class="number">1</span>;
<span class="keyword">if</span> num_frames < <span class="number">1</span>, y = x; start_idx = <span class="number">1</span>; end_idx = N; <span class="keyword">return</span>; <span class="keyword">end</span>

energy = zeros(num_frames, <span class="number">1</span>);
<span class="keyword">for</span> i = <span class="number">1</span>:num_frames
    s = (i - <span class="number">1</span>) * frame_shift + <span class="number">1</span>;
    energy(i) = sum(x(s : s + frame_len - <span class="number">1</span>).^<span class="number">2</span>);
<span class="keyword">end</span>

max_energy = max(energy);
<span class="keyword">if</span> max_energy <= <span class="number">0</span>, y = x; start_idx = <span class="number">1</span>; end_idx = N; <span class="keyword">return</span>; <span class="keyword">end</span>
energy_norm = energy / max_energy;

speech_high = energy_norm > thresh_high;
<span class="keyword">if</span> ~any(speech_high), speech_high = energy_norm > thresh_low; <span class="keyword">end</span>
<span class="keyword">if</span> ~any(speech_high), y = x; start_idx = <span class="number">1</span>; end_idx = N; <span class="keyword">return</span>; <span class="keyword">end</span>

first_high = find(speech_high, <span class="number">1</span>, <span class="string">'first'</span>);
last_high = find(speech_high, <span class="number">1</span>, <span class="string">'last'</span>);

start_frame = first_high;
<span class="keyword">while</span> start_frame > <span class="number">1</span> && energy_norm(start_frame - <span class="number">1</span>) > thresh_low
    start_frame = start_frame - <span class="number">1</span>;
<span class="keyword">end</span>
end_frame = last_high;
<span class="keyword">while</span> end_frame < num_frames && energy_norm(end_frame + <span class="number">1</span>) > thresh_low
    end_frame = end_frame + <span class="number">1</span>;
<span class="keyword">end</span>

start_frame = max(<span class="number">1</span>, start_frame - margin);
end_frame = min(num_frames, end_frame + margin);

start_idx = (start_frame - <span class="number">1</span>) * frame_shift + <span class="number">1</span>;
end_idx = min(N, (end_frame - <span class="number">1</span>) * frame_shift + frame_len);
y = x(start_idx : end_idx);
<span class="keyword">end</span></pre>
            </div>
        </div>

    </div>

    <script>
        function toggleBlock(header) { header.parentElement.classList.toggle('collapsed'); }
        function expandAll() { document.querySelectorAll('.file-block').forEach(b => b.classList.remove('collapsed')); }
        function collapseAll() { document.querySelectorAll('.file-block').forEach(b => b.classList.add('collapsed')); }
        function copyCode(event, codeId) {
            event.stopPropagation();
            const code = document.getElementById(codeId).innerText;
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                setTimeout(() => { btn.textContent = 'å¤åˆ¶ä»£ç '; }, 2000);
            });
        }
    </script>
</body>
</html>