<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSP-Proj4 ç»ƒä¹ æµ‹éªŒ - DTWè¯­éŸ³è¯†åˆ«å®éªŒ</title>
    
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [['$','$'], ['\\(','\\)']],
                displayMath: [['$$','$$'], ['\\[','\\]']],
                processEscapes: true
            }
        });
    </script>

    <style>
        .mathjax-status {
            position: fixed;
            top: 10px;
            right: 15px;
            padding: 8px 15px;
            border-radius: 5px;
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            font-size: 14px;
            z-index: 10000;
            font-family: 'Microsoft YaHei', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        .mathjax-status.loading {
            background-color: #fff3cd;
            color: #856404;
            border-color: #ffeeba;
        }
        .mathjax-status.success {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
            transition: opacity 0.5s ease-out 1.5s;
            opacity: 0;
        }
    </style>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', 'SimSun', Arial, sans-serif;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.25);
            padding: 40px;
        }

        h1 {
            color: #11998e;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }

        h2 {
            color: #11998e;
            margin: 25px 0 15px 0;
        }

        .login-section, .quiz-section, .result-section {
            display: none;
        }

        .login-section.active, .quiz-section.active, .result-section.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #11998e;
            font-weight: bold;
            margin-bottom: 8px;
        }

        input[type="text"], input[type="number"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #38ef7d;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 3px 10px rgba(17, 153, 142, 0.3);
        }

        button:hover {
            background: linear-gradient(135deg, #0d7a72 0%, #11998e 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.5);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .question-box {
            background: #f8f9fa;
            border-left: 5px solid #11998e;
            padding: 25px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .question-title {
            color: #11998e;
            font-weight: bold;
            font-size: 1.2em;
            margin-bottom: 15px;
        }

        .options {
            margin: 15px 0;
        }

        .option {
            display: block;
            background: white;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .option:hover {
            background: #e8f5f3;
            border-color: #11998e;
        }

        .option.selected {
            background: #11998e;
            color: white;
            border-color: #0d7a72;
        }

        .option.correct {
            background: #48bb78;
            color: white;
            border-color: #38a169;
        }

        .option.incorrect {
            background: #f56565;
            color: white;
            border-color: #e53e3e;
        }

        .feedback {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }

        .feedback.correct {
            background: #e8f5e9;
            color: #48bb78;
            border-left: 5px solid #48bb78;
        }

        .feedback.incorrect {
            background: #ffebee;
            color: #f56565;
            border-left: 5px solid #f56565;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #48bb78 0%, #11998e 100%);
            transition: width 0.5s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .stats-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .stats-table th, .stats-table td {
            padding: 12px;
            text-align: left;
            border: 1px solid #e0e0e0;
        }

        .stats-table th {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
        }

        .stats-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .mastery-excellent {
            color: #48bb78;
            font-weight: bold;
        }

        .mastery-good {
            color: #11998e;
            font-weight: bold;
        }

        .mastery-fair {
            color: #ed8936;
            font-weight: bold;
        }

        .mastery-poor {
            color: #f56565;
            font-weight: bold;
        }

        .info-box {
            background: #fff8e1;
            border-left: 5px solid #ed8936;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
        }

        input[type="checkbox"] {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        .checkbox-option {
            display: flex;
            align-items: center;
            background: white;
            padding: 12px;
            margin: 8px 0;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .checkbox-option:hover {
            background: #e8f5f3;
            border-color: #11998e;
        }

        .checkbox-option.correct {
            background: #e8f5e9;
            border-color: #48bb78;
        }

        .checkbox-option.incorrect {
            background: #ffebee;
            border-color: #f56565;
        }

        .checkbox-option.missed {
            background: #fff3e0;
            border-color: #ed8936;
        }

        .tf-options {
            display: flex;
            gap: 15px;
            margin: 15px 0;
        }

        .tf-option {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .tf-option:hover {
            border-color: #11998e;
        }

        .tf-option.selected {
            background: #11998e;
            color: white;
            border-color: #0d7a72;
        }

        .tf-option.correct {
            background: #48bb78;
            color: white;
        }

        .tf-option.incorrect {
            background: #f56565;
            color: white;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .nav-buttons button {
            flex: 1;
        }

        .topic-progress {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .topic-badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .topic-badge.current {
            background: #11998e;
            color: white;
        }

        .topic-badge.completed {
            background: #48bb78;
            color: white;
        }

        .topic-badge.pending {
            background: #e0e0e0;
            color: #666;
        }

        .screenshot-area {
            padding: 20px;
            background: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- MathJaxçŠ¶æ€æŒ‡ç¤º -->
        <div id="mathjax-status" class="mathjax-status loading">â³ å…¬å¼åŠ è½½ä¸­...</div>

        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-section active">
            <h1>ğŸ¤ DSP-Proj4 ç»ƒä¹ æµ‹éªŒ</h1>
            <h2 style="text-align: center; color: #666; font-weight: normal;">DTWè¯­éŸ³è¯†åˆ«å®éªŒ</h2>
            
            <div class="info-box">
                <strong>ğŸ“‹ æµ‹éªŒè¯´æ˜:</strong><br>
                â€¢ æœ¬æµ‹éªŒæ¶µç›–DTWè¯­éŸ³è¯†åˆ«å®éªŒçš„5ä¸ªæ ¸å¿ƒçŸ¥è¯†ç‚¹<br>
                â€¢ æ¯ä¸ªçŸ¥è¯†ç‚¹éšæœºæŠ½å–1é“é¢˜,å…±5é“é¢˜<br>
                â€¢ é¢˜å‹åŒ…æ‹¬:å•é€‰é¢˜ã€å¤šé€‰é¢˜ã€åˆ¤æ–­é¢˜<br>
                â€¢ å®Œæˆåå¯æŸ¥çœ‹å„çŸ¥è¯†ç‚¹æŒæ¡æƒ…å†µ
            </div>

            <div class="form-group">
                <label>å­¦å·:</label>
                <input type="text" id="studentId" placeholder="è¯·è¾“å…¥å­¦å·">
            </div>
            <div class="form-group">
                <label>å§“å:</label>
                <input type="text" id="studentName" placeholder="è¯·è¾“å…¥å§“å">
            </div>
            <button onclick="startQuiz()">å¼€å§‹æµ‹éªŒ</button>
        </div>

        <!-- ç­”é¢˜ç•Œé¢ -->
        <div class="quiz-section">
            <h1>ğŸ¤ DTWè¯­éŸ³è¯†åˆ«æµ‹éªŒ</h1>
            
            <div class="topic-progress" id="topicProgress"></div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>

            <div id="questionContainer"></div>

            <div class="nav-buttons">
                <button id="submitBtn" onclick="submitAnswer()">æäº¤ç­”æ¡ˆ</button>
                <button id="nextBtn" onclick="nextQuestion()" style="display:none;">ä¸‹ä¸€é¢˜</button>
            </div>
        </div>

        <!-- ç»“æœç•Œé¢ -->
        <div class="result-section">
            <h1>ğŸ“Š æµ‹éªŒç»“æœæŠ¥å‘Š</h1>
            <div id="finalReport"></div>
            <button id="saveBtn">æˆªå›¾ä¿å­˜</button>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®ç»“æ„ ====================
        let studentData = {
            id: '',
            name: '',
            topicStats: {},
            currentTopicIndex: 0,
            currentQuestionIndex: 0,
            usedQuestions: {}
        };

        // çŸ¥è¯†ç‚¹å®šä¹‰
        const topics = [
            {
                name: 'é¢„åŠ é‡',
                id: 'preemphasis',
                description: 'é«˜é€šæ»¤æ³¢å™¨ï¼Œå¢å¼ºé«˜é¢‘æˆåˆ†'
            },
            {
                name: 'åˆ†å¸§å¤„ç†',
                id: 'framing',
                description: 'å¸§é•¿ã€å¸§ç§»ã€é‡å ç‡è®¡ç®—'
            },
            {
                name: 'åŠ çª—å¤„ç†',
                id: 'windowing',
                description: 'æ±‰å®çª—ã€çª—å‡½æ•°ä½œç”¨'
            },
            {
                name: 'MFCCç‰¹å¾æå–',
                id: 'mfcc',
                description: 'Melæ»¤æ³¢å™¨ã€DCTå˜æ¢'
            },
            {
                name: 'DTWåŠ¨æ€æ—¶é—´è§„æ•´',
                id: 'dtw',
                description: 'è·ç¦»è®¡ç®—ã€åŠ¨æ€è§„åˆ’ã€æœ€ä¼˜è·¯å¾„'
            }
        ];

        // ==================== å·¥å…·å‡½æ•° ====================
        
        function randInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function randChoice(arr) {
            return arr[randInt(0, arr.length - 1)];
        }

        function randFloat(min, max, decimals = 2) {
            return (Math.random() * (max - min) + min).toFixed(decimals);
        }

        // å•é€‰é¢˜é€‰é¡¹æ‰“ä¹±å‡½æ•°
        function shuffleOptionsWithAnswer(options, correctIndex) {
            const indices = options.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return {
                options: indices.map(i => options[i]),
                correct: indices.indexOf(correctIndex)
            };
        }

        // å¤šé€‰é¢˜é€‰é¡¹æ‰“ä¹±å‡½æ•°
        function shuffleOptionsWithAnswers(options, correctIndices) {
            const indices = options.map((_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            return {
                options: indices.map(i => options[i]),
                correct: correctIndices.map(ci => indices.indexOf(ci)).sort((a, b) => a - b)
            };
        }

        // ==================== é¢˜ç›®ç”Ÿæˆå‡½æ•° ====================
        
        const questionGenerators = {
            // ========== çŸ¥è¯†ç‚¹1: é¢„åŠ é‡ ==========
            preemphasis: [
                // é¢„åŠ é‡é¢˜ç›®1: åŸºæœ¬å…¬å¼
                () => {
                    const alpha = randChoice([0.95, 0.97, 0.98]);
                    return {
                        type: 'single',
                        question: `é¢„åŠ é‡æ»¤æ³¢å™¨çš„å·®åˆ†æ–¹ç¨‹ä¸º $y[n] = x[n] - \\alpha x[n-1]$ï¼Œå½“ $\\alpha = ${alpha}$ æ—¶ï¼Œå¯¹åº”çš„æ»¤æ³¢å™¨ç³»æ•°ä¸º:`,
                        options: [
                            `$[1, -${alpha}]$`,
                            `$[1, ${alpha}]$`,
                            `$[-1, ${alpha}]$`,
                            `$[${alpha}, -1]$`
                        ],
                        correct: 0,
                        explanation: `é¢„åŠ é‡æ»¤æ³¢å™¨ $y[n] = x[n] - \\alpha x[n-1]$ å¯¹åº” MATLAB ä¸­ filter([1, -Î±], 1, x)ï¼Œç³»æ•°ä¸º $[1, -${alpha}]$ã€‚`
                    };
                },
                
                // é¢„åŠ é‡é¢˜ç›®2: æ»¤æ³¢å™¨ç±»å‹
                () => {
                    return {
                        type: 'single',
                        question: 'é¢„åŠ é‡æ»¤æ³¢å™¨æœ¬è´¨ä¸Šæ˜¯ä»€ä¹ˆç±»å‹çš„æ»¤æ³¢å™¨?',
                        options: [
                            'é«˜é€šæ»¤æ³¢å™¨',
                            'ä½é€šæ»¤æ³¢å™¨',
                            'å¸¦é€šæ»¤æ³¢å™¨',
                            'å¸¦é˜»æ»¤æ³¢å™¨'
                        ],
                        correct: 0,
                        explanation: 'é¢„åŠ é‡æ˜¯ä¸€é˜¶é«˜é€šæ»¤æ³¢å™¨ï¼Œå®ƒå¢å¼ºé«˜é¢‘æˆåˆ†ï¼ŒæŠ‘åˆ¶ä½é¢‘æˆåˆ†ã€‚è¿™æ˜¯å› ä¸ºè¯­éŸ³ä¿¡å·é«˜é¢‘èƒ½é‡è¾ƒå¼±ï¼Œéœ€è¦è¡¥å¿ã€‚'
                    };
                },
                
                // é¢„åŠ é‡é¢˜ç›®3: ä½œç”¨
                () => {
                    return {
                        type: 'single',
                        question: 'åœ¨è¯­éŸ³å¤„ç†ä¸­ï¼Œé¢„åŠ é‡çš„ä¸»è¦ç›®çš„æ˜¯:',
                        options: [
                            'è¡¥å¿è¯­éŸ³ä¿¡å·çš„é«˜é¢‘è¡°å‡',
                            'å»é™¤å™ªå£°',
                            'é™ä½é‡‡æ ·ç‡',
                            'å¢åŠ ä¿¡å·é•¿åº¦'
                        ],
                        correct: 0,
                        explanation: 'è¯­éŸ³ä¿¡å·åœ¨å‘éŸ³è¿‡ç¨‹ä¸­é«˜é¢‘åˆ†é‡ä¼šè¡°å‡ï¼Œé¢„åŠ é‡é€šè¿‡é«˜é€šæ»¤æ³¢è¡¥å¿è¿™ç§è¡°å‡ï¼Œä½¿é¢‘è°±æ›´å¹³å¦ã€‚'
                    };
                },
                
                // é¢„åŠ é‡é¢˜ç›®4: åˆ¤æ–­é¢˜
                () => {
                    return {
                        type: 'tf',
                        question: 'åˆ¤æ–­: é¢„åŠ é‡ç³»æ•° $\\alpha$ é€šå¸¸å–å€¼æ¥è¿‘1(å¦‚0.95~0.98)ï¼Œå€¼è¶Šå¤§é«˜é¢‘å¢å¼ºè¶Šæ˜æ˜¾ã€‚',
                        correct: true,
                        explanation: 'æ­£ç¡®ã€‚$\\alpha$ è¶Šæ¥è¿‘1ï¼Œé«˜é€šæ»¤æ³¢æ•ˆæœè¶Šå¼ºï¼Œé«˜é¢‘å¢å¼ºè¶Šæ˜æ˜¾ã€‚é€šå¸¸å–0.95~0.98ã€‚'
                    };
                },
                
                // é¢„åŠ é‡é¢˜ç›®5: å¤šé€‰é¢˜
                () => {
                    return {
                        type: 'multiple',
                        question: 'å…³äºé¢„åŠ é‡ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯:(å¤šé€‰)',
                        options: [
                            'é¢„åŠ é‡æ˜¯ä¸€ç§é«˜é€šæ»¤æ³¢å¤„ç†',
                            'é¢„åŠ é‡å¯ä»¥ä½¿è¯­éŸ³é¢‘è°±æ›´åŠ å¹³å¦',
                            'é¢„åŠ é‡ç³»æ•°é€šå¸¸å–0.95~0.98',
                            'é¢„åŠ é‡ä¼šå¢åŠ ä¿¡å·çš„æ€»èƒ½é‡'
                        ],
                        correct: [0, 1, 2],
                        explanation: 'é¢„åŠ é‡æ˜¯é«˜é€šæ»¤æ³¢ï¼Œä½¿é¢‘è°±å¹³å¦åŒ–ï¼Œç³»æ•°é€šå¸¸å–0.95~0.98ã€‚å®ƒä¸ä¼šå¢åŠ æ€»èƒ½é‡ï¼Œè€Œæ˜¯é‡æ–°åˆ†é…èƒ½é‡ã€‚'
                    };
                }
            ],

            // ========== çŸ¥è¯†ç‚¹2: åˆ†å¸§å¤„ç† ==========
            framing: [
                // åˆ†å¸§é¢˜ç›®1: å¸§æ•°è®¡ç®—
                () => {
                    const L = randChoice([8000, 16000, 24000]);
                    const frameLen = randChoice([256, 512]);
                    const frameShift = frameLen / 2;
                    const numFrames = Math.floor((L - frameLen) / frameShift) + 1;
                    return {
                        type: 'single',
                        question: `ä¿¡å·é•¿åº¦ $L=${L}$ ç‚¹ï¼Œå¸§é•¿ $N=${frameLen}$ ç‚¹ï¼Œå¸§ç§» $M=${frameShift}$ ç‚¹ï¼Œåˆ™å¸§æ•°ä¸º:`,
                        options: [
                            `${numFrames}`,
                            `${Math.floor(L / frameLen)}`,
                            `${Math.floor(L / frameShift)}`,
                            `${numFrames + 1}`
                        ],
                        correct: 0,
                        explanation: `å¸§æ•°å…¬å¼: $\\lfloor(L-N)/M\\rfloor + 1 = \\lfloor(${L}-${frameLen})/${frameShift}\\rfloor + 1 = ${numFrames}$`
                    };
                },
                
                // åˆ†å¸§é¢˜ç›®2: èµ·å§‹ä½ç½®
                () => {
                    const frameShift = randChoice([128, 256]);
                    const k = randInt(2, 5);
                    const startIdx = (k - 1) * frameShift + 1;
                    return {
                        type: 'single',
                        question: `å¸§ç§»ä¸º $M=${frameShift}$ ç‚¹ï¼Œç¬¬ $${k}$ å¸§çš„èµ·å§‹ç´¢å¼•(ä»1å¼€å§‹)ä¸º:`,
                        options: [
                            `${startIdx}`,
                            `${k * frameShift}`,
                            `${k * frameShift + 1}`,
                            `${(k - 1) * frameShift}`
                        ],
                        correct: 0,
                        explanation: `ç¬¬kå¸§èµ·å§‹ç´¢å¼•(ä»1å¼€å§‹): $(k-1) \\times M + 1 = (${k}-1) \\times ${frameShift} + 1 = ${startIdx}$`
                    };
                },
                
                // åˆ†å¸§é¢˜ç›®3: é‡å ç‡
                () => {
                    const frameLen = randChoice([256, 512, 1024]);
                    const overlap = randChoice([0.25, 0.5, 0.75]);
                    const frameShift = frameLen * (1 - overlap);
                    return {
                        type: 'single',
                        question: `å¸§é•¿ $N=${frameLen}$ ç‚¹ï¼Œé‡å ç‡ä¸º ${overlap*100}%ï¼Œåˆ™å¸§ç§»ä¸º:`,
                        options: [
                            `${frameShift} ç‚¹`,
                            `${frameLen * overlap} ç‚¹`,
                            `${frameLen} ç‚¹`,
                            `${frameLen / 2} ç‚¹`
                        ],
                        correct: 0,
                        explanation: `å¸§ç§» $M = N \\times (1 - é‡å ç‡) = ${frameLen} \\times (1 - ${overlap}) = ${frameShift}$ ç‚¹`
                    };
                },
                
                // åˆ†å¸§é¢˜ç›®4: åˆ¤æ–­é¢˜
                () => {
                    return {
                        type: 'tf',
                        question: 'åˆ¤æ–­: å¸§ç§»è¶Šå°ï¼Œç›¸é‚»å¸§ä¹‹é—´çš„é‡å è¶Šå¤§ï¼Œæ—¶é—´åˆ†è¾¨ç‡è¶Šé«˜ã€‚',
                        correct: true,
                        explanation: 'æ­£ç¡®ã€‚å¸§ç§»å°æ„å‘³ç€ç›¸é‚»å¸§é‡å å¤šï¼Œèƒ½æ›´ç»†è‡´åœ°æ•æ‰ä¿¡å·çš„æ—¶å˜ç‰¹æ€§ï¼Œæ—¶é—´åˆ†è¾¨ç‡æ›´é«˜ã€‚'
                    };
                },
                
                // åˆ†å¸§é¢˜ç›®5: å¤šé€‰é¢˜
                () => {
                    return {
                        type: 'multiple',
                        question: 'å…³äºè¯­éŸ³åˆ†å¸§ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯:(å¤šé€‰)',
                        options: [
                            'å…¸å‹å¸§é•¿ä¸º20-30msï¼Œä»¥ä¿è¯çŸ­æ—¶å¹³ç¨³æ€§',
                            'ç›¸é‚»å¸§é€šå¸¸æœ‰50%çš„é‡å ',
                            'å¸§ç§» = å¸§é•¿ Ã— (1 - é‡å ç‡)',
                            'å¸§é•¿è¶Šé•¿ï¼Œé¢‘ç‡åˆ†è¾¨ç‡è¶Šé«˜'
                        ],
                        correct: [0, 1, 2, 3],
                        explanation: 'è¯­éŸ³åœ¨20-30mså†…è¿‘ä¼¼å¹³ç¨³ï¼›50%é‡å æ˜¯å¸¸ç”¨è®¾ç½®ï¼›å¸§ç§»ä¸é‡å ç‡çš„å…³ç³»æ­£ç¡®ï¼›å¸§é•¿è¶Šé•¿FFTç‚¹æ•°è¶Šå¤šï¼Œé¢‘ç‡åˆ†è¾¨ç‡è¶Šé«˜ã€‚'
                    };
                }
            ],

            // ========== çŸ¥è¯†ç‚¹3: åŠ çª—å¤„ç† ==========
            windowing: [
                // åŠ çª—é¢˜ç›®1: æ±‰å®çª—å…¬å¼
                () => {
                    return {
                        type: 'single',
                        question: 'æ±‰å®çª—(Hanning window)çš„æ•°å­¦è¡¨è¾¾å¼ä¸º:',
                        options: [
                            '$w[n] = 0.5 - 0.5\\cos(\\frac{2\\pi n}{N-1})$',
                            '$w[n] = 0.54 - 0.46\\cos(\\frac{2\\pi n}{N-1})$',
                            '$w[n] = 1$ (çŸ©å½¢çª—)',
                            '$w[n] = \\sin(\\frac{\\pi n}{N-1})$'
                        ],
                        correct: 0,
                        explanation: 'æ±‰å®çª—: $w[n] = 0.5 - 0.5\\cos(\\frac{2\\pi n}{N-1})$ã€‚æ±‰æ˜çª—ç³»æ•°ä¸º0.54å’Œ0.46ã€‚'
                    };
                },
                
                // åŠ çª—é¢˜ç›®2: åŠ çª—ç›®çš„
                () => {
                    return {
                        type: 'single',
                        question: 'å¯¹è¯­éŸ³å¸§è¿›è¡ŒåŠ çª—å¤„ç†çš„ä¸»è¦ç›®çš„æ˜¯:',
                        options: [
                            'å‡å°‘é¢‘è°±æ³„éœ²',
                            'å¢åŠ ä¿¡å·èƒ½é‡',
                            'æé«˜é‡‡æ ·ç‡',
                            'å»é™¤ç›´æµåˆ†é‡'
                        ],
                        correct: 0,
                        explanation: 'åŠ çª—ä½¿å¸§è¾¹ç¼˜å¹³æ»‘è¿‡æ¸¡åˆ°é›¶ï¼Œå‡å°‘æˆªæ–­é€ æˆçš„é¢‘è°±æ³„éœ²(æ—ç“£)ï¼Œä½¿é¢‘è°±åˆ†ææ›´å‡†ç¡®ã€‚'
                    };
                },
                
                // åŠ çª—é¢˜ç›®3: MATLABå‡½æ•°
                () => {
                    const N = randChoice([256, 512, 1024]);
                    return {
                        type: 'single',
                        question: `åœ¨MATLABä¸­ç”Ÿæˆé•¿åº¦ä¸º${N}çš„å‘¨æœŸæ€§æ±‰å®çª—ï¼Œæ­£ç¡®çš„å‡½æ•°è°ƒç”¨æ˜¯:`,
                        options: [
                            `hann(${N}, 'periodic')`,
                            `hanning(${N})`,
                            `hamming(${N})`,
                            `window(${N})`
                        ],
                        correct: 0,
                        explanation: `MATLABä¸­ä½¿ç”¨ hann(N, 'periodic') ç”Ÿæˆå‘¨æœŸæ€§æ±‰å®çª—ï¼Œé€‚åˆFFTåˆ†æã€‚`
                    };
                },
                
                // åŠ çª—é¢˜ç›®4: åˆ¤æ–­é¢˜
                () => {
                    return {
                        type: 'tf',
                        question: 'åˆ¤æ–­: æ±‰å®çª—å’Œæ±‰æ˜çª—ç›¸æ¯”ï¼Œæ±‰å®çª—çš„ä¸»ç“£æ›´çª„ä½†æ—ç“£æ›´é«˜ã€‚',
                        correct: false,
                        explanation: 'é”™è¯¯ã€‚æ±‰å®çª—çš„æ—ç“£æ¯”æ±‰æ˜çª—ä½(çº¦-31dB vs -43dB)ï¼Œä½†ä¸»ç“£ç•¥å®½ã€‚æ±‰æ˜çª—åœ¨è¾¹ç¼˜ä¸é™åˆ°é›¶ã€‚'
                    };
                },
                
                // åŠ çª—é¢˜ç›®5: å¤šé€‰é¢˜
                () => {
                    return {
                        type: 'multiple',
                        question: 'å…³äºçª—å‡½æ•°ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯:(å¤šé€‰)',
                        options: [
                            'çŸ©å½¢çª—ç›¸å½“äºä¸åŠ çª—ï¼Œä¼šäº§ç”Ÿä¸¥é‡çš„é¢‘è°±æ³„éœ²',
                            'æ±‰å®çª—ä¸¤ç«¯å¹³æ»‘è¿‡æ¸¡åˆ°é›¶',
                            'åŠ çª—ä¼šé™ä½é¢‘ç‡åˆ†è¾¨ç‡',
                            'çª—å‡½æ•°çš„é€‰æ‹©å½±å“é¢‘è°±åˆ†æçš„ç²¾åº¦'
                        ],
                        correct: [0, 1, 2, 3],
                        explanation: 'çŸ©å½¢çª—æœ‰ä¸¥é‡æ³„éœ²ï¼›æ±‰å®çª—å¹³æ»‘åˆ°é›¶ï¼›åŠ çª—ä½¿ä¸»ç“£å˜å®½é™ä½åˆ†è¾¨ç‡ï¼›çª—å‡½æ•°é€‰æ‹©å¾ˆé‡è¦ã€‚'
                    };
                }
            ],

            // ========== çŸ¥è¯†ç‚¹4: MFCCç‰¹å¾æå– ==========
            mfcc: [
                // MFCCé¢˜ç›®1: å¤„ç†æµç¨‹
                () => {
                    return {
                        type: 'single',
                        question: 'MFCCç‰¹å¾æå–çš„æ­£ç¡®å¤„ç†é¡ºåºæ˜¯:',
                        options: [
                            'åŠ çª— â†’ FFT â†’ åŠŸç‡è°± â†’ Melæ»¤æ³¢ â†’ å–å¯¹æ•° â†’ DCT',
                            'FFT â†’ åŠ çª— â†’ Melæ»¤æ³¢ â†’ åŠŸç‡è°± â†’ DCT â†’ å–å¯¹æ•°',
                            'Melæ»¤æ³¢ â†’ FFT â†’ åŠ çª— â†’ å–å¯¹æ•° â†’ åŠŸç‡è°± â†’ DCT',
                            'åŠ çª— â†’ Melæ»¤æ³¢ â†’ FFT â†’ DCT â†’ å–å¯¹æ•° â†’ åŠŸç‡è°±'
                        ],
                        correct: 0,
                        explanation: 'MFCCæµç¨‹: åŠ çª— â†’ FFT â†’ åŠŸç‡è°± â†’ Melæ»¤æ³¢å™¨ç»„ â†’ å–å¯¹æ•° â†’ DCT â†’ ä¿ç•™ä½é˜¶ç³»æ•°ã€‚'
                    };
                },
                
                // MFCCé¢˜ç›®2: Melé¢‘ç‡
                () => {
                    return {
                        type: 'single',
                        question: 'Melé¢‘ç‡å°ºåº¦çš„ç‰¹ç‚¹æ˜¯:',
                        options: [
                            'ä½é¢‘åŒºåˆ†è¾¨ç‡é«˜ï¼Œé«˜é¢‘åŒºåˆ†è¾¨ç‡ä½',
                            'é«˜é¢‘åŒºåˆ†è¾¨ç‡é«˜ï¼Œä½é¢‘åŒºåˆ†è¾¨ç‡ä½',
                            'å…¨é¢‘æ®µåˆ†è¾¨ç‡ç›¸åŒ',
                            'åªå…³æ³¨ä¸­é¢‘åŒºåŸŸ'
                        ],
                        correct: 0,
                        explanation: 'Melå°ºåº¦æ¨¡æ‹Ÿäººè€³å¬è§‰ç‰¹æ€§:å¯¹ä½é¢‘æ•æ„Ÿ(åˆ†è¾¨ç‡é«˜)ï¼Œå¯¹é«˜é¢‘ä¸æ•æ„Ÿ(åˆ†è¾¨ç‡ä½)ã€‚'
                    };
                },
                
                // MFCCé¢˜ç›®3: åŠŸç‡è°±è®¡ç®—
                () => {
                    return {
                        type: 'single',
                        question: 'åŠŸç‡è°± $P[k]$ ä¸FFTç»“æœ $X[k]$ çš„å…³ç³»æ˜¯:',
                        options: [
                            '$P[k] = |X[k]|^2$',
                            '$P[k] = |X[k]|$',
                            '$P[k] = X[k]^2$',
                            '$P[k] = \\log|X[k]|$'
                        ],
                        correct: 0,
                        explanation: 'åŠŸç‡è°±æ˜¯FFTå¹…åº¦çš„å¹³æ–¹: $P[k] = |X[k]|^2$ã€‚åœ¨MATLABä¸­å¯ç”¨ abs(X).^2 è®¡ç®—ã€‚'
                    };
                },
                
                // MFCCé¢˜ç›®4: DCTä½œç”¨
                () => {
                    return {
                        type: 'single',
                        question: 'MFCCä¸­ä½¿ç”¨DCT(ç¦»æ•£ä½™å¼¦å˜æ¢)çš„ä¸»è¦ç›®çš„æ˜¯:',
                        options: [
                            'å»ç›¸å…³ï¼Œå°†èƒ½é‡é›†ä¸­åˆ°ä½é˜¶ç³»æ•°',
                            'å¢åŠ ç‰¹å¾ç»´åº¦',
                            'å°†ä¿¡å·è½¬æ¢åˆ°é¢‘åŸŸ',
                            'å¢å¼ºé«˜é¢‘æˆåˆ†'
                        ],
                        correct: 0,
                        explanation: 'DCTå¯¹Melæ»¤æ³¢å™¨è¾“å‡ºè¿›è¡Œå»ç›¸å…³å¤„ç†ï¼Œèƒ½é‡é›†ä¸­åˆ°å‰å‡ ä¸ªç³»æ•°ï¼Œé€šå¸¸åªä¿ç•™å‰12-13ä¸ªä½œä¸ºMFCCç‰¹å¾ã€‚'
                    };
                },
                
                // MFCCé¢˜ç›®5: å¤šé€‰é¢˜
                () => {
                    return {
                        type: 'multiple',
                        question: 'å…³äºMFCCç‰¹å¾ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯:(å¤šé€‰)',
                        options: [
                            'MFCCæ¨¡æ‹Ÿäº†äººè€³çš„å¬è§‰ç‰¹æ€§',
                            'Melæ»¤æ³¢å™¨ç»„åœ¨ä½é¢‘åŒºæ›´å¯†é›†',
                            'é€šå¸¸åªä¿ç•™DCTçš„å‰12-13ä¸ªç³»æ•°',
                            'å–å¯¹æ•°å¯ä»¥å‹ç¼©åŠ¨æ€èŒƒå›´'
                        ],
                        correct: [0, 1, 2, 3],
                        explanation: 'MFCCåŸºäºäººè€³å¬è§‰ï¼›Melæ»¤æ³¢å™¨ä½é¢‘å¯†é›†ï¼›ä¿ç•™ä½é˜¶DCTç³»æ•°ï¼›å¯¹æ•°å‹ç¼©åŠ¨æ€èŒƒå›´ã€‚'
                    };
                }
            ],

            // ========== çŸ¥è¯†ç‚¹5: DTWåŠ¨æ€æ—¶é—´è§„æ•´ ==========
            dtw: [
                // DTWé¢˜ç›®1: åŸºæœ¬æ¦‚å¿µ
                () => {
                    return {
                        type: 'single',
                        question: 'DTW(åŠ¨æ€æ—¶é—´è§„æ•´)ç®—æ³•çš„ä¸»è¦ç›®çš„æ˜¯:',
                        options: [
                            'æ‰¾åˆ°ä¸¤ä¸ªä¸ç­‰é•¿åºåˆ—ä¹‹é—´çš„æœ€ä¼˜å¯¹é½',
                            'è®¡ç®—ä¸¤ä¸ªç­‰é•¿åºåˆ—çš„ç›¸ä¼¼åº¦',
                            'å¯¹ä¿¡å·è¿›è¡Œæ»¤æ³¢',
                            'æå–é¢‘ç‡ç‰¹å¾'
                        ],
                        correct: 0,
                        explanation: 'DTWé€šè¿‡åŠ¨æ€è§„åˆ’æ‰¾åˆ°ä¸¤ä¸ªå¯èƒ½ä¸ç­‰é•¿åºåˆ—ä¹‹é—´çš„æœ€ä¼˜å¯¹é½è·¯å¾„ï¼Œå…‹æœè¯­é€Ÿå·®å¼‚çš„å½±å“ã€‚'
                    };
                },
                
                // DTWé¢˜ç›®2: è·ç¦»è®¡ç®—
                () => {
                    return {
                        type: 'single',
                        question: 'DTWä¸­è®¡ç®—ç‰¹å¾å‘é‡ä¹‹é—´è·ç¦»é€šå¸¸ä½¿ç”¨:',
                        options: [
                            'æ¬§æ°è·ç¦»',
                            'æ›¼å“ˆé¡¿è·ç¦»',
                            'ä½™å¼¦ç›¸ä¼¼åº¦',
                            'æ±‰æ˜è·ç¦»'
                        ],
                        correct: 0,
                        explanation: 'DTWé€šå¸¸ä½¿ç”¨æ¬§æ°è·ç¦»: $d(i,j) = \\|x_i - y_j\\|_2$ï¼Œè®¡ç®—ä¸¤ä¸ªç‰¹å¾å‘é‡çš„è·ç¦»ã€‚'
                    };
                },
                
                // DTWé¢˜ç›®3: é€’æ¨å…¬å¼
                () => {
                    return {
                        type: 'single',
                        question: 'DTWç´¯ç§¯è·ç¦»çŸ©é˜µçš„é€’æ¨å…¬å¼ä¸º:',
                        options: [
                            '$D(i,j) = d(i,j) + \\min\\{D(i-1,j), D(i,j-1), D(i-1,j-1)\\}$',
                            '$D(i,j) = d(i,j) + D(i-1,j-1)$',
                            '$D(i,j) = \\min\\{d(i-1,j), d(i,j-1), d(i-1,j-1)\\}$',
                            '$D(i,j) = d(i,j) \\times D(i-1,j-1)$'
                        ],
                        correct: 0,
                        explanation: 'é€’æ¨å…¬å¼: å½“å‰è·ç¦» = å±€éƒ¨è·ç¦» + ä¸‰ä¸ªæ–¹å‘(å·¦ã€ä¸‹ã€å·¦ä¸‹)ä¸­çš„æœ€å°ç´¯ç§¯è·ç¦»ã€‚'
                    };
                },
                
                // DTWé¢˜ç›®4: è¾¹ç•Œæ¡ä»¶
                () => {
                    return {
                        type: 'single',
                        question: 'DTWç´¯ç§¯è·ç¦»çŸ©é˜µçš„åˆå§‹åŒ–ä¸­ï¼Œ$D(1,1)$ çš„å€¼ä¸º:',
                        options: [
                            '$d(1,1)$ï¼Œå³ç¬¬ä¸€å¯¹å…ƒç´ çš„å±€éƒ¨è·ç¦»',
                            '0',
                            '1',
                            '$\\infty$'
                        ],
                        correct: 0,
                        explanation: '$D(1,1) = d(1,1)$ï¼Œèµ·ç‚¹çš„ç´¯ç§¯è·ç¦»ç­‰äºç¬¬ä¸€å¯¹å…ƒç´ çš„å±€éƒ¨è·ç¦»ã€‚å…¶ä»–è¾¹ç•Œè®¾ä¸º$\\infty$ã€‚'
                    };
                },
                
                // DTWé¢˜ç›®5: å¤šé€‰é¢˜
                () => {
                    return {
                        type: 'multiple',
                        question: 'å…³äºDTWç®—æ³•ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯:(å¤šé€‰)',
                        options: [
                            'DTWå¯ä»¥å¤„ç†ä¸ç­‰é•¿åºåˆ—çš„åŒ¹é…',
                            'æœ€ä¼˜è·¯å¾„ä»(1,1)åˆ°(N,M)',
                            'è·¯å¾„åªèƒ½å‘å³ã€å‘ä¸Šã€æˆ–å¯¹è§’ç§»åŠ¨',
                            'DTWè·ç¦»è¶Šå°è¡¨ç¤ºä¸¤åºåˆ—è¶Šç›¸ä¼¼'
                        ],
                        correct: [0, 1, 2, 3],
                        explanation: 'DTWå¤„ç†ä¸ç­‰é•¿åºåˆ—ï¼›è·¯å¾„ä»èµ·ç‚¹åˆ°ç»ˆç‚¹ï¼›ä¸‰ä¸ªå…è®¸æ–¹å‘ï¼›è·ç¦»è¶Šå°è¶Šç›¸ä¼¼ã€‚'
                    };
                }
            ]
        };

        // ==================== æ ¸å¿ƒé€»è¾‘ ====================
        
        let currentQuestion = null;
        let userAnswer = null;
        let answered = false;

        function startQuiz() {
            const id = document.getElementById('studentId').value.trim();
            const name = document.getElementById('studentName').value.trim();
            
            if (!id || !name) {
                alert('è¯·è¾“å…¥å­¦å·å’Œå§“å!');
                return;
            }
            
            studentData.id = id;
            studentData.name = name;
            studentData.currentTopicIndex = 0;
            studentData.usedQuestions = {};
            
            // åˆå§‹åŒ–æ¯ä¸ªçŸ¥è¯†ç‚¹çš„ç»Ÿè®¡
            topics.forEach(topic => {
                studentData.topicStats[topic.id] = {
                    correct: 0,
                    total: 0,
                    questions: []
                };
                studentData.usedQuestions[topic.id] = [];
            });
            
            document.querySelector('.login-section').classList.remove('active');
            document.querySelector('.quiz-section').classList.add('active');
            
            loadQuestion();
        }

        function loadQuestion() {
            const topic = topics[studentData.currentTopicIndex];
            const generators = questionGenerators[topic.id];
            
            // éšæœºé€‰æ‹©ä¸€ä¸ªæœªä½¿ç”¨çš„é¢˜ç›®ç”Ÿæˆå™¨
            let availableIndices = [];
            for (let i = 0; i < generators.length; i++) {
                if (!studentData.usedQuestions[topic.id].includes(i)) {
                    availableIndices.push(i);
                }
            }
            
            if (availableIndices.length === 0) {
                availableIndices = generators.map((_, i) => i);
            }
            
            const selectedIndex = randChoice(availableIndices);
            studentData.usedQuestions[topic.id].push(selectedIndex);
            
            currentQuestion = generators[selectedIndex]();
            userAnswer = null;
            answered = false;
            
            renderQuestion();
            updateProgress();
        }

        function renderQuestion() {
            const topic = topics[studentData.currentTopicIndex];
            const container = document.getElementById('questionContainer');
            
            let html = `
                <div class="question-box">
                    <div class="question-title">
                        ã€${topic.name}ã€‘ç¬¬ ${studentData.currentTopicIndex + 1} / ${topics.length} é¢˜
                    </div>
                    <p style="margin: 15px 0; font-size: 1.1em;">${currentQuestion.question}</p>
            `;
            
            if (currentQuestion.type === 'single') {
                // æ‰“ä¹±é€‰é¡¹
                const shuffled = shuffleOptionsWithAnswer(currentQuestion.options, currentQuestion.correct);
                currentQuestion.shuffledOptions = shuffled.options;
                currentQuestion.shuffledCorrect = shuffled.correct;
                
                html += '<div class="options">';
                shuffled.options.forEach((opt, i) => {
                    html += `<div class="option" data-index="${i}" onclick="selectOption(this, ${i})">${String.fromCharCode(65 + i)}. ${opt}</div>`;
                });
                html += '</div>';
            } else if (currentQuestion.type === 'multiple') {
                // æ‰“ä¹±é€‰é¡¹
                const shuffled = shuffleOptionsWithAnswers(currentQuestion.options, currentQuestion.correct);
                currentQuestion.shuffledOptions = shuffled.options;
                currentQuestion.shuffledCorrect = shuffled.correct;
                
                html += '<div class="options">';
                shuffled.options.forEach((opt, i) => {
                    html += `<label class="checkbox-option" data-index="${i}">
                        <input type="checkbox" value="${i}" onchange="updateMultipleSelection()">
                        ${String.fromCharCode(65 + i)}. ${opt}
                    </label>`;
                });
                html += '</div>';
            } else if (currentQuestion.type === 'tf') {
                html += `
                    <div class="tf-options">
                        <div class="tf-option" data-value="true" onclick="selectTF(this, true)">âœ“ æ­£ç¡®</div>
                        <div class="tf-option" data-value="false" onclick="selectTF(this, false)">âœ— é”™è¯¯</div>
                    </div>
                `;
            }
            
            html += '<div id="feedback"></div></div>';
            container.innerHTML = html;
            
            document.getElementById('submitBtn').style.display = 'block';
            document.getElementById('nextBtn').style.display = 'none';
            
            // è§¦å‘MathJaxæ¸²æŸ“
            if (window.MathJax) {
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, container]);
            }
        }

        function selectOption(element, index) {
            if (answered) return;
            document.querySelectorAll('.option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            userAnswer = index;
        }

        function selectTF(element, value) {
            if (answered) return;
            document.querySelectorAll('.tf-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            userAnswer = value;
        }

        function updateMultipleSelection() {
            if (answered) return;
            const checkboxes = document.querySelectorAll('.checkbox-option input:checked');
            userAnswer = Array.from(checkboxes).map(cb => parseInt(cb.value)).sort((a, b) => a - b);
        }

        function submitAnswer() {
            if (userAnswer === null || (Array.isArray(userAnswer) && userAnswer.length === 0)) {
                alert('è¯·é€‰æ‹©ç­”æ¡ˆ!');
                return;
            }
            
            answered = true;
            const topic = topics[studentData.currentTopicIndex];
            let isCorrect = false;
            
            if (currentQuestion.type === 'single') {
                isCorrect = userAnswer === currentQuestion.shuffledCorrect;
                
                document.querySelectorAll('.option').forEach((opt, i) => {
                    if (i === currentQuestion.shuffledCorrect) {
                        opt.classList.add('correct');
                    } else if (i === userAnswer && !isCorrect) {
                        opt.classList.add('incorrect');
                    }
                });
            } else if (currentQuestion.type === 'multiple') {
                const correctSet = new Set(currentQuestion.shuffledCorrect);
                const userSet = new Set(userAnswer);
                isCorrect = correctSet.size === userSet.size && 
                           [...correctSet].every(x => userSet.has(x));
                
                document.querySelectorAll('.checkbox-option').forEach((opt, i) => {
                    if (correctSet.has(i) && userSet.has(i)) {
                        opt.classList.add('correct');
                    } else if (correctSet.has(i) && !userSet.has(i)) {
                        opt.classList.add('missed');
                    } else if (!correctSet.has(i) && userSet.has(i)) {
                        opt.classList.add('incorrect');
                    }
                });
            } else if (currentQuestion.type === 'tf') {
                isCorrect = userAnswer === currentQuestion.correct;
                
                document.querySelectorAll('.tf-option').forEach(opt => {
                    const val = opt.dataset.value === 'true';
                    if (val === currentQuestion.correct) {
                        opt.classList.add('correct');
                    } else if (val === userAnswer && !isCorrect) {
                        opt.classList.add('incorrect');
                    }
                });
            }
            
            // è®°å½•ç»“æœ
            studentData.topicStats[topic.id].total++;
            if (isCorrect) {
                studentData.topicStats[topic.id].correct++;
            }
            studentData.topicStats[topic.id].questions.push({
                question: currentQuestion.question,
                correct: isCorrect
            });
            
            // æ˜¾ç¤ºåé¦ˆ
            const feedback = document.getElementById('feedback');
            feedback.className = 'feedback ' + (isCorrect ? 'correct' : 'incorrect');
            feedback.innerHTML = `
                <strong>${isCorrect ? 'âœ“ å›ç­”æ­£ç¡®!' : 'âœ— å›ç­”é”™è¯¯'}</strong><br>
                <span style="color: #333; font-weight: normal;">${currentQuestion.explanation}</span>
            `;
            
            // è§¦å‘MathJaxæ¸²æŸ“
            if (window.MathJax) {
                MathJax.Hub.Queue(["Typeset", MathJax.Hub, feedback]);
            }
            
            document.getElementById('submitBtn').style.display = 'none';
            document.getElementById('nextBtn').style.display = 'block';
        }

        function nextQuestion() {
            studentData.currentTopicIndex++;
            
            if (studentData.currentTopicIndex >= topics.length) {
                showResults();
            } else {
                loadQuestion();
            }
        }

        function updateProgress() {
            const progress = ((studentData.currentTopicIndex) / topics.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressFill').textContent = Math.round(progress) + '%';
            
            // æ›´æ–°çŸ¥è¯†ç‚¹è¿›åº¦
            let html = '';
            topics.forEach((topic, i) => {
                let status = 'pending';
                if (i < studentData.currentTopicIndex) status = 'completed';
                else if (i === studentData.currentTopicIndex) status = 'current';
                html += `<span class="topic-badge ${status}">${topic.name}</span>`;
            });
            document.getElementById('topicProgress').innerHTML = html;
        }

        function showResults() {
            document.querySelector('.quiz-section').classList.remove('active');
            document.querySelector('.result-section').classList.add('active');
            
            let totalCorrect = 0;
            let totalQuestions = 0;
            
            let tableHtml = `
                <div class="screenshot-area" id="screenshotArea">
                    <h2>ğŸ‘¤ ${studentData.name} (${studentData.id})</h2>
                    <p style="color: #666;">æµ‹éªŒæ—¶é—´: ${new Date().toLocaleString()}</p>
                    
                    <table class="stats-table">
                        <tr>
                            <th>çŸ¥è¯†ç‚¹</th>
                            <th>æ­£ç¡®/æ€»æ•°</th>
                            <th>æ­£ç¡®ç‡</th>
                            <th>æŒæ¡ç¨‹åº¦</th>
                        </tr>
            `;
            
            topics.forEach(topic => {
                const stats = studentData.topicStats[topic.id];
                totalCorrect += stats.correct;
                totalQuestions += stats.total;
                
                const rate = stats.total > 0 ? (stats.correct / stats.total * 100) : 0;
                let mastery = '';
                let masteryClass = '';
                
                if (rate >= 80) {
                    mastery = 'ä¼˜ç§€';
                    masteryClass = 'mastery-excellent';
                } else if (rate >= 60) {
                    mastery = 'è‰¯å¥½';
                    masteryClass = 'mastery-good';
                } else if (rate >= 40) {
                    mastery = 'ä¸€èˆ¬';
                    masteryClass = 'mastery-fair';
                } else {
                    mastery = 'éœ€åŠ å¼º';
                    masteryClass = 'mastery-poor';
                }
                
                tableHtml += `
                    <tr>
                        <td><strong>${topic.name}</strong><br><small style="color:#666">${topic.description}</small></td>
                        <td>${stats.correct} / ${stats.total}</td>
                        <td>${rate.toFixed(0)}%</td>
                        <td class="${masteryClass}">${mastery}</td>
                    </tr>
                `;
            });
            
            const overallRate = totalQuestions > 0 ? (totalCorrect / totalQuestions * 100) : 0;
            
            tableHtml += `
                    <tr style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white;">
                        <td><strong>æ€»è®¡</strong></td>
                        <td><strong>${totalCorrect} / ${totalQuestions}</strong></td>
                        <td><strong>${overallRate.toFixed(0)}%</strong></td>
                        <td><strong>${overallRate >= 80 ? 'ä¼˜ç§€' : overallRate >= 60 ? 'è‰¯å¥½' : overallRate >= 40 ? 'ä¸€èˆ¬' : 'éœ€åŠ å¼º'}</strong></td>
                    </tr>
                </table>
                
                <div class="info-box" style="margin-top: 20px;">
                    <strong>ğŸ“ å­¦ä¹ å»ºè®®:</strong><br>
            `;
            
            topics.forEach(topic => {
                const stats = studentData.topicStats[topic.id];
                const rate = stats.total > 0 ? (stats.correct / stats.total * 100) : 0;
                if (rate < 60) {
                    tableHtml += `â€¢ <strong>${topic.name}</strong>: ${topic.description}ï¼Œå»ºè®®å¤ä¹ ç›¸å…³å†…å®¹<br>`;
                }
            });
            
            if (overallRate >= 80) {
                tableHtml += 'â€¢ æ•´ä½“æŒæ¡è‰¯å¥½ï¼Œå¯ä»¥è¿›è¡Œå®éªŒç¼–ç¨‹<br>';
            }
            
            tableHtml += '</div></div>';
            
            document.getElementById('finalReport').innerHTML = tableHtml;
            
            // æˆªå›¾ä¿å­˜æŒ‰é’®
            document.getElementById('saveBtn').onclick = function() {
                html2canvas(document.getElementById('screenshotArea'), {
                    backgroundColor: '#ffffff',
                    scale: 2
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `DSP-Proj4-Quiz-${studentData.id}-${studentData.name}.png`;
                    link.href = canvas.toDataURL();
                    link.click();
                });
            };
        }

        // ==================== åˆå§‹åŒ– ====================
        
        // MathJaxåŠ è½½æ£€æµ‹
        window.addEventListener('load', function() {
            const statusEl = document.getElementById('mathjax-status');
            
            // åŠ¨æ€åŠ è½½MathJax
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
            script.async = true;
            
            script.onload = function() {
                // ç­‰å¾…MathJaxåˆå§‹åŒ–
                if (window.MathJax) {
                    MathJax.Hub.Queue(function() {
                        statusEl.textContent = 'âœ“ å…¬å¼å·²å°±ç»ª';
                        statusEl.classList.remove('loading');
                        statusEl.classList.add('success');
                    });
                }
            };
            
            script.onerror = function() {
                statusEl.textContent = 'âš  å…¬å¼åŠ è½½å¤±è´¥(ä¸å½±å“ç­”é¢˜)';
            };
            
            document.head.appendChild(script);
        });
    </script>
</body>
</html>
