<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>DSP é¡¹ç›®3 - éŸ³é¢‘å˜è°ƒå®éªŒä»£ç æ¨¡æ¿</title>
    <style>
        body { font-family: 'Segoe UI', Consolas, 'Microsoft YaHei', sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        .control-panel {
            position: sticky; top: 0; z-index: 100;
            background: white; padding: 15px; margin-bottom: 20px;
            border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            display: flex; justify-content: space-between; align-items: center;
        }
        .control-btn {
            background: #e74c3c; color: white; border: none; padding: 8px 16px;
            border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px;
        }
        .control-btn:hover { background: #c0392b; }
        .control-btn.secondary { background: #8e44ad; }

        .file-block { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        
        .file-header { 
            background: linear-gradient(135deg, #e74c3c 0%, #8e44ad 100%); 
            color: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; user-select: none;
        }
        .file-header:hover { opacity: 0.9; }
        .file-header.completed { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .file-header.helper { background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%); }
        
        .file-title { font-weight: bold; display: flex; align-items: center; }
        .arrow-icon { display: inline-block; margin-right: 10px; transition: transform 0.3s; }
        .file-block.collapsed .arrow-icon { transform: rotate(-90deg); }
        
        .file-content { display: block; }
        .file-block.collapsed .file-content { display: none; }

        .copy-btn { background: #48bb78; border: none; color: white; padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .copy-btn:hover { background: #38a169; }

        pre { margin: 0; padding: 20px; overflow-x: auto; line-height: 1.8; font-size: 13px; background: #f8f9fa; border-top: 1px solid #e9ecef; }
        
        .keyword { color: #0000ff; font-weight: bold; }
        .comment { color: #228b22; font-style: italic; }
        .string { color: #a020f0; }
        .number { color: #ff0000; }
        .todo { background: #fff3cd; color: #856404; padding: 2px 6px; border-radius: 3px; border: 1px solid #ffeeba; font-weight: bold; }
        
        .info-banner { background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%); border-left: 4px solid #e74c3c; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .warning-banner { background: linear-gradient(135deg, #fff3cd 0%, #fffdf7 100%); border-left: 4px solid #ed8936; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .success-banner { background: linear-gradient(135deg, #f0fff4 0%, #f7fafc 100%); border-left: 4px solid #48bb78; padding: 15px; margin-bottom: 20px; border-radius: 4px; }
        .test-banner { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 4px; }

        code { background: #edf2f7; padding: 2px 6px; border-radius: 3px; color: #e74c3c; font-size: 0.95em; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.8em; margin-left: 10px; }
        .tag-required { background: #fed7d7; color: #c53030; }
        .tag-completed { background: #c6f6d5; color: #276749; }
        .tag-helper { background: #e2e8f0; color: #4a5568; }
    </style>
</head>
<body>
    <div class="container">
        <div class="control-panel">
            <h2 style="margin:0; color:#e74c3c;">ğŸµ DSP é¡¹ç›®3 - éŸ³é¢‘å˜è°ƒå®éªŒä»£ç æ¨¡æ¿</h2>
            <div>
                <button class="control-btn" onclick="expandAll()">å…¨éƒ¨å±•å¼€</button>
                <button class="control-btn secondary" onclick="collapseAll()">å…¨éƒ¨æŠ˜å </button>
            </div>
        </div>

        <div class="info-banner">
            <strong>ğŸ“Œ é¡¹ç›®è¯´æ˜ï¼š</strong>
            <ul style="margin:5px 0 0 20px; padding:0; line-height:1.8;">
                <li>æœ¬é¡¹ç›®å®ç°åŸºäº<strong>ç›¸ä½å£°ç å™¨ï¼ˆPhase Vocoderï¼‰</strong>çš„éŸ³é¢‘å˜è°ƒæŠ€æœ¯</li>
                <li>ä»£ç ä¸­ <code>?</code> æ ‡è®°å¤„éœ€è¦å¡«å†™åˆé€‚çš„ä»£ç </li>
                <li><code>ex1</code> å’Œ <code>ex4</code> å·²å®Œæˆï¼Œ<strong>æ— éœ€ä¿®æ”¹</strong></li>
                <li><code>stft_custom</code> å’Œ <code>istft_custom</code> æ˜¯è¾…åŠ©å‡½æ•°ï¼Œæ— éœ€ä¿®æ”¹</li>
                <li>å®Œæˆåä½¿ç”¨ <code>test_Project3.p</code> è¿›è¡Œè‡ªåŠ¨æ£€æŸ¥</li>
            </ul>
        </div>

        <div class="warning-banner">
            <strong>âš ï¸ æäº¤æ¸…å•ï¼š</strong>
            <ul style="margin:5px 0 0 20px; padding:0;">
                <li>ex0_all.mï¼ˆä¸»å‡½æ•°ï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span></li>
                <li>ex2_process_method1.mï¼ˆæ–¹æ³•ä¸€å˜è°ƒï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span></li>
                <li>ex2_process_method2.mï¼ˆæ–¹æ³•äºŒå˜è°ƒï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span></li>
                <li>ex3_formant.mï¼ˆå…±æŒ¯å³°ä¿®æ­£ï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span></li>
                <li>ex5_reformation.mï¼ˆæ’å€¼é‡å»ºï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span></li>
            </ul>
        </div>

        <div class="success-banner">
            <strong>âœ… å®éªŒæµç¨‹ï¼š</strong>
            <ol style="margin:5px 0 0 20px; padding:0; line-height:1.8;">
                <li>é˜…è¯»å®éªŒæ‰‹å†Œã€Šäººå£°å˜è°ƒã€‹ï¼ˆproj3_handoutï¼‰</li>
                <li>æŒ‰é¡ºåºå®Œæˆ ex0, ex2, ex3, ex5ï¼Œå¡«å†™æ ‡è®°ä¸º <code>?</code> çš„ä»£ç </li>
                <li>è¿è¡Œ <code>test_Project3.p</code> æ£€æŸ¥ä»£ç </li>
                <li>è¾“å…¥ 9 ç”ŸæˆåŠ å¯†æˆç»©ï¼Œå°†æ–‡ä»¶å‹ç¼©ä¸ºã€å­¦å·_å§“å.zipã€‘æäº¤</li>
            </ol>
        </div>

        <!-- ex0 ä¸»å‡½æ•° -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex0_all.mï¼ˆä¸»å‡½æ•°ï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code0')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code0"><span class="keyword">function</span> [y_interpolated, fs] = ex0_all(audio_path, alpha, Lwin, Ra, useMethod, beta)
<span class="comment">% EX0_ALL - æ ¹æ®æŒ‡å®šå‚æ•°å¯¹éŸ³é¢‘æ–‡ä»¶è¿›è¡Œå˜è°ƒå¤„ç†</span>
<span class="comment">%</span>
<span class="comment">% è¾“å…¥å‚æ•°ï¼š</span>
<span class="comment">%   audio_path  - è¾“å…¥éŸ³é¢‘æ–‡ä»¶çš„è·¯å¾„</span>
<span class="comment">%   alpha       - å˜è°ƒå› å­ (alpha > 1 å‡è°ƒ, alpha < 1 é™è°ƒ)</span>
<span class="comment">%   Lwin        - çª—é•¿</span>
<span class="comment">%   Ra          - åˆ†æå¸§ç§»</span>
<span class="comment">%   useMethod   - 1 ä½¿ç”¨æ–¹æ³•ä¸€ï¼Œ2 ä½¿ç”¨æ–¹æ³•äºŒ</span>
<span class="comment">%   beta        - æ˜¯å¦å¯ç”¨å…±æŒ¯å³°ä¿®æ­£ï¼ˆå¯é€‰ï¼Œé»˜è®¤ä¸º1ï¼‰</span>

<span class="comment">% å¤„ç†å¯é€‰å‚æ•°</span>
<span class="keyword">if</span> nargin < 6
    beta = 1;
<span class="keyword">end</span>

<span class="comment">% æ¸…ç©ºå˜é‡å’Œå…³é—­å›¾å½¢çª—å£</span>
clc;
clearvars -except audio_path alpha Lwin Ra useMethod beta;
close all;

<span class="comment">% è¯»å–è¾“å…¥éŸ³é¢‘æ–‡ä»¶</span>
[x, fs] = audioread(audio_path);

<span class="comment">% ç¡®ä¿ä¿¡å·ä¸ºåˆ—å‘é‡</span>
<span class="keyword">if</span> size(x, 2) > 1
    x = x(:, 1);
<span class="keyword">end</span>
x = x(:);

<span class="comment">% å¯¹è¾“å…¥éŸ³é¢‘è¿›è¡Œ STFT é¢‘è°±åˆ†æ</span>
Freq = ex1_analysis(x, fs, Lwin, Ra);

<span class="comment">% æ ¹æ®é€‰æ‹©çš„æ–¹æ³•å¯¹é¢‘è°±è¿›è¡Œå¤„ç†</span>
<span class="keyword">if</span> useMethod == 1
    <span class="comment">% æ–¹æ³•1ï¼šPhase Vocoderï¼Œæ”¹å˜åˆæˆå¸§ç§»å®ç°å˜é€Ÿ</span>
    Freq_out = ex2_process_method1(Freq, Lwin, Ra, alpha);
    <span class="comment">% TODO: æ–¹æ³•1çš„åˆæˆå¸§ç§» = ?</span>
    synthesize_param = <span class="todo">?</span>;
<span class="keyword">elseif</span> useMethod == 2
    <span class="comment">% æ–¹æ³•2ï¼šé¢‘è°±å¸§æ“ä½œ</span>
    Freq_out = ex2_process_method2(Freq, Lwin, Ra, alpha);
    <span class="comment">% TODO: æ–¹æ³•2çš„åˆæˆå¸§ç§» = ?</span>
    synthesize_param = <span class="todo">?</span>;
<span class="keyword">else</span>
    error(<span class="string">'useMethod å‚æ•°å¿…é¡»ä¸º 1 æˆ– 2'</span>);
<span class="keyword">end</span>

<span class="comment">% è°ƒæ•´å…±æŒ¯å³°</span>
Freq_out_tuned = ex3_formant(Freq_out, alpha);

<span class="comment">% å°†å¤„ç†åçš„é¢‘è°±é€šè¿‡ ISTFT åˆæˆå›æ—¶åŸŸä¿¡å·</span>
y_out = ex4_synthesis(Freq_out_tuned, Lwin, fs, synthesize_param);

<span class="comment">% è°ƒæ•´è¾“å‡ºä¿¡å·é•¿åº¦ï¼Œä½¿å…¶ä¸åŸå§‹ä¿¡å·é•¿åº¦ä¸€è‡´</span>
y_interpolated = ex5_reformation(y_out, length(x));

<span class="comment">% æ’­æ”¾å¤„ç†åçš„éŸ³é¢‘</span>
sound(y_interpolated, fs);
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex1 å·²å®Œæˆ -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex1_analysis.mï¼ˆSTFTåˆ†æï¼‰<span class="tag tag-completed">å·²å®Œæˆ</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code1')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code1"><span class="keyword">function</span> Freq = ex1_analysis(x, fs, Lwin, Ra)
<span class="comment">% EX1_ANALYSIS å¯¹è¾“å…¥ä¿¡å·è¿›è¡ŒçŸ­æ—¶å‚…é‡Œå¶å˜æ¢ï¼ˆSTFTï¼‰</span>
<span class="comment">% æ­¤å‡½æ•°å·²å®Œæˆï¼Œæ— éœ€ä¿®æ”¹</span>

x = x(:);

Freq = stft_custom(x, fs, ...
    <span class="string">'Window'</span>, hann(Lwin, <span class="string">'periodic'</span>), ...
    <span class="string">'FFTLength'</span>, Lwin, ...
    <span class="string">'OverlapLength'</span>, Lwin - Ra, ...
    <span class="string">'FrequencyRange'</span>, <span class="string">'onesided'</span>);
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex2_process_method1 -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex2_process_method1.mï¼ˆæ–¹æ³•ä¸€å˜è°ƒï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code2a')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code2a"><span class="keyword">function</span> [Freq_out] = ex2_process_method1(Freq, Lwin, Ra, alpha)
<span class="comment">% EX2_PROCESS_METHOD1 é¢‘è°±å¤„ç†ï¼ˆæ–¹æ³•ä¸€ï¼šPhase Vocoderï¼‰</span>
<span class="comment">%</span>
<span class="comment">% æ–¹æ³•ä¸€åŸç†ï¼šé€šè¿‡ä¿®æ”¹åˆæˆå¸§ç§»Rså®ç°æ—¶é—´ä¼¸ç¼©ï¼ŒåŒæ—¶ä¿®æ­£ç›¸ä½ä¿è¯é¢‘ç‡è¿ç»­æ€§</span>

<span class="comment">% è·å–é¢‘è°±çŸ©é˜µçš„å¤§å°</span>
[num_freqs, num_frames] = size(Freq);

<span class="comment">% è®¡ç®—é¢‘ç‡ç´¢å¼•å’Œç†è®ºè§’é¢‘ç‡</span>
k = (0:num_freqs-1)';
Omega = 2 * pi * k / Lwin;

<span class="comment">% è®¡ç®—åˆæˆå¸§ç§»</span>
Rs = Ra * alpha;

<span class="comment">% åˆå§‹åŒ–ç›¸ä½å˜é‡</span>
prev_phase = zeros(num_freqs, 1);
phase_out = zeros(num_freqs, 1);

<span class="comment">% TODO: åˆå§‹åŒ–è¾“å‡ºé¢‘è°±çŸ©é˜µ</span>
Freq_out = <span class="todo">?</span>;

<span class="comment">% ä»ç¬¬2å¸§å¼€å§‹å¤„ç†</span>
<span class="keyword">for</span> idx = <span class="todo">?</span>
    <span class="comment">% æå–å½“å‰å¸§çš„å¹…åº¦å’Œç›¸ä½</span>
    Amp = abs(Freq(:, idx));
    Pha = angle(Freq(:, idx));

    <span class="comment">% TODO: è®¡ç®—ç›¸ä½å¢é‡ï¼ˆç›¸ä½å±•å¼€ï¼‰</span>
    <span class="comment">% å…¬å¼: mod(å½“å‰ç›¸ä½ - ä¸Šä¸€å¸§ç›¸ä½ - ç†è®ºå¢é‡ + Ï€, 2Ï€) - Ï€</span>
    delta_phase = <span class="todo">?</span>;

    <span class="comment">% æ›´æ–°ä¸Šä¸€å¸§ç›¸ä½</span>
    prev_phase = Pha;

    <span class="comment">% TODO: è®¡ç®—é¢‘ç‡åç§»é‡</span>
    delta_w = <span class="todo">?</span>;
    
    <span class="comment">% TODO: ç´¯ç§¯è¾“å‡ºç›¸ä½ï¼ˆä½¿ç”¨çœŸå®é¢‘ç‡ Ã— åˆæˆå¸§ç§»ï¼‰</span>
    phase_out = <span class="todo">?</span>;

    <span class="comment">% TODO: ç”Ÿæˆè¾“å‡ºé¢‘è°±ï¼ˆå¹…åº¦ Ã— å¤æŒ‡æ•°ç›¸ä½ï¼‰</span>
    Freq_out(:, idx) = <span class="todo">?</span>;
<span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex2_process_method2 -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex2_process_method2.mï¼ˆæ–¹æ³•äºŒå˜è°ƒï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code2b')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code2b"><span class="keyword">function</span> [Freq_out] = ex2_process_method2(Freq, Lwin, Ra, alpha)
<span class="comment">% EX2_PROCESS_METHOD2 é¢‘è°±å¤„ç†ï¼ˆæ–¹æ³•äºŒï¼šé¢‘è°±å¸§æ“ä½œï¼‰</span>
<span class="comment">%</span>
<span class="comment">% æ–¹æ³•äºŒåŸç†ï¼šé€šè¿‡å¯¹é¢‘è°±å¸§è¿›è¡ŒæŠ½å–æˆ–å¤åˆ¶æ”¹å˜å¸§æ•°ï¼Œé‡å»ºæ—¶ä½¿ç”¨åŸå¸§ç§»Ra</span>

<span class="comment">% è·å–é¢‘è°±çŸ©é˜µçš„å¤§å°</span>
[num_freqs, num_frames] = size(Freq);

<span class="comment">% è®¡ç®—é¢‘ç‡ç´¢å¼•å’Œç†è®ºè§’é¢‘ç‡</span>
k = (0:num_freqs-1)';
Omega = 2 * pi * k / Lwin;

<span class="comment">% åˆå§‹åŒ–ç´¯ç§¯ç›¸ä½</span>
phase_out = zeros(num_freqs, 1);

<span class="comment">% TODO: è®¡ç®—æ–°çš„æ—¶é—´ç´¢å¼•</span>
<span class="comment">% ä¾‹å¦‚ï¼šalpha=2æ—¶ï¼Œå¸§æ•°å¢åŠ ï¼›alpha=0.5æ—¶ï¼Œå¸§æ•°å‡å°‘</span>
t = <span class="todo">?</span>;

<span class="comment">% è®¡ç®—è¾“å‡ºå¸§æ•°</span>
num_frames_out = length(t);

<span class="comment">% TODO: åˆå§‹åŒ–è¾“å‡ºé¢‘è°±çŸ©é˜µ</span>
Freq_out = <span class="todo">?</span>;

<span class="comment">% åˆå§‹åŒ–å¸§è®¡æ•°å™¨</span>
itr = <span class="todo">?</span>;

<span class="comment">% éå†æ¯ä¸ªæ–°çš„æ—¶é—´ç´¢å¼•</span>
<span class="keyword">for</span> idx = t
    <span class="comment">% TODO: è®¡ç®—å½“å‰å¸§ç´¢å¼•</span>
    col = <span class="todo">?</span>;
    
    <span class="comment">% è¾¹ç•Œæ£€æŸ¥</span>
    <span class="keyword">if</span> col >= num_frames
        col = num_frames - 1;
    <span class="keyword">end</span>
    <span class="keyword">if</span> col < 1
        col = 1;
    <span class="keyword">end</span>
    
    <span class="comment">% è®¡ç®—æ’å€¼ç³»æ•°</span>
    delta = idx - col;
    
    <span class="comment">% è·å–ç›¸é‚»å¸§å¹…å€¼å¹¶è¿›è¡Œçº¿æ€§æ’å€¼</span>
    p0Amp = abs(Freq(:, col));
    p1Amp = abs(Freq(:, min(col + 1, num_frames)));
    Amp = (1 - delta) * p0Amp + delta * p1Amp;
    
    <span class="comment">% è·å–ç›¸é‚»å¸§ç›¸ä½</span>
    p0Pha = angle(Freq(:, col));
    p1Pha = angle(Freq(:, min(col + 1, num_frames)));
    
    <span class="comment">% è®¡ç®—ç›¸ä½å¢é‡ï¼ˆç›¸ä½å±•å¼€ï¼‰</span>
    delta_phase = mod(p1Pha - p0Pha - Omega * Ra + pi, 2 * pi) - pi;
    
    <span class="comment">% ç´¯ç§¯ç›¸ä½</span>
    phase_out = phase_out + Omega * Ra + delta_phase;
    
    <span class="comment">% TODO: ç”Ÿæˆè¾“å‡ºé¢‘è°±</span>
    Freq_out(:, itr) = <span class="todo">?</span>;
    itr = itr + 1;
<span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex3_formant -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex3_formant.mï¼ˆå…±æŒ¯å³°ä¿®æ­£ï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code3')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code3"><span class="keyword">function</span> new_Freq = ex3_formant(Freq_out, alpha)
<span class="comment">% EX3_FORMANT å¯¹è¾“å…¥çš„é¢‘è°±è¿›è¡Œå…±æŒ¯å³°ä¿®æ­£</span>
<span class="comment">%</span>
<span class="comment">% å…±æŒ¯å³°ä¿®æ­£åŸç†ï¼š</span>
<span class="comment">% 1. æå–é¢‘è°±åŒ…ç»œï¼ˆä»£è¡¨å…±æŒ¯å³°ä½ç½®ï¼‰</span>
<span class="comment">% 2. è®¡ç®—æ®‹å·® = é¢‘è°± / åŒ…ç»œ</span>
<span class="comment">% 3. æ ¹æ®å˜è°ƒå› å­è°ƒæ•´åŒ…ç»œ</span>
<span class="comment">% 4. è¾“å‡º = æ®‹å·® Ã— è°ƒæ•´åçš„åŒ…ç»œ</span>

[num_freqs, num_frames] = size(Freq_out);
new_Freq = zeros(size(Freq_out));
new_Freq(:, 1) = Freq_out(:, 1);

<span class="keyword">for</span> idx = 2:num_frames
    <span class="comment">% æå–å¹…åº¦è°±å’Œç›¸ä½è°±</span>
    Amp = abs(Freq_out(:, idx));
    phase_out = angle(Freq_out(:, idx));
    Amp_len = length(Amp);

    <span class="comment">% æ‰¾åˆ°å¹…åº¦è°±çš„å³°å€¼ä½œä¸ºå…±æŒ¯å³°ä¼°è®¡</span>
    [pks, loc] = findpeaks(Amp, <span class="string">'MinPeakDistance'</span>, max(1, floor(Amp_len/20)));
    
    <span class="keyword">if</span> isempty(pks)
        env = Amp;
    <span class="keyword">else</span>
        <span class="comment">% å¯¹å³°å€¼è¿›è¡Œæ’å€¼å¾—åˆ°åŒ…ç»œ</span>
        loc_extended = [1; loc(:); Amp_len];
        pks_extended = [Amp(1); pks(:); Amp(end)];
        env = interp1(loc_extended, pks_extended, (1:Amp_len)', <span class="string">'linear'</span>, <span class="string">'extrap'</span>);
    <span class="keyword">end</span>

    env(isnan(env)) = eps;
    env = max(env, eps);

    <span class="comment">% è®¡ç®—æ®‹å·®è°±</span>
    indices = env > eps;
    Amp_res = Amp;
    Amp_res(indices) = Amp(indices) ./ env(indices);

    <span class="comment">% æ ¹æ®alphaè°ƒæ•´åŒ…ç»œ</span>
    <span class="keyword">if</span> alpha > 1
        cut = max(1, fix(Amp_len / alpha));
        spec_donor = zeros(size(Amp));
        old_indices = linspace(1, length(env), cut);
        new_indices = 1:cut;
        spec_donor(new_indices) = interp1(1:length(env), env, old_indices, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);
    <span class="keyword">else</span>
        cut = max(1, fix(length(env) * alpha));
        old_indices = 1:cut;
        new_indices = linspace(1, cut, Amp_len);
        spec_donor = interp1(old_indices, env(1:cut), new_indices, <span class="string">'linear'</span>, <span class="string">'extrap'</span>);
        spec_donor = spec_donor(:);
    <span class="keyword">end</span>
    
    spec_donor(isnan(spec_donor)) = eps;
    spec_donor = max(spec_donor, 0);

    <span class="comment">% åˆæˆæ–°çš„å¹…åº¦è°±</span>
    new_Amp = Amp_res .* spec_donor;

    <span class="comment">% ä½é€šæ»¤æ³¢</span>
    filter_order = min(8, floor(Amp_len/4));
    cutoff_freq = min(0.99, 300/Amp_len);
    
    <span class="keyword">if</span> cutoff_freq > 0 && cutoff_freq < 1 && filter_order > 0
        <span class="comment">% TODO: è®¾è®¡å·´ç‰¹æ²ƒæ–¯ä½é€šæ»¤æ³¢å™¨</span>
        [b, a] = <span class="todo">?</span>;
        <span class="comment">% TODO: è®¡ç®—æ»¤æ³¢å™¨é¢‘ç‡å“åº”</span>
        [h, ~] = <span class="todo">?</span>;
        new_Amp = new_Amp .* abs(h);
    <span class="keyword">end</span>

    <span class="comment">% TODO: ç”Ÿæˆæ–°çš„å¤æ•°é¢‘è°±</span>
    new_Freq(:, idx) = <span class="todo">?</span>;
<span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex4 å·²å®Œæˆ -->
        <div class="file-block collapsed">
            <div class="file-header completed" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex4_synthesis.mï¼ˆISTFTåˆæˆï¼‰<span class="tag tag-completed">å·²å®Œæˆ</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code4')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code4"><span class="keyword">function</span> y = ex4_synthesis(Freq_out, Lwin, fs, Rs)
<span class="comment">% EX4_SYNTHESIS ä½¿ç”¨ ISTFT é‡å»ºæ—¶åŸŸä¿¡å·</span>
<span class="comment">% æ­¤å‡½æ•°å·²å®Œæˆï¼Œæ— éœ€ä¿®æ”¹</span>

Rs = max(1, floor(Rs));
overlap_length = Lwin - Rs;
overlap_length = max(0, min(overlap_length, Lwin - 1));

y = istft_custom(Freq_out, fs, ...
    <span class="string">'Window'</span>, hann(Lwin, <span class="string">'periodic'</span>), ...
    <span class="string">'FFTLength'</span>, Lwin, ...
    <span class="string">'OverlapLength'</span>, overlap_length, ...
    <span class="string">'FrequencyRange'</span>, <span class="string">'onesided'</span>, ...
    <span class="string">'ConjugateSymmetric'</span>, true);
y = y(:);
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- ex5_reformation -->
        <div class="file-block">
            <div class="file-header" onclick="toggleBlock(this)">
                <span class="file-title">
                    <span class="arrow-icon">â–¼</span>
                    ğŸ“„ ex5_reformation.mï¼ˆæ’å€¼é‡å»ºï¼‰<span class="tag tag-required">éœ€ä¿®æ”¹</span>
                </span>
                <button class="copy-btn" onclick="copyCode(event, 'code5')">å¤åˆ¶ä»£ç </button>
            </div>
            <div class="file-content">
                <pre id="code5"><span class="keyword">function</span> [y_interpolated] = ex5_reformation(y, lx)
<span class="comment">% EX5_REFORMATION å¯¹ä¿¡å·è¿›è¡Œæ’å€¼é‡å»º</span>
<span class="comment">%</span>
<span class="comment">% å°†å˜é€Ÿåçš„ä¿¡å·æ¢å¤åˆ°åŸå§‹é•¿åº¦ï¼Œå®ç°"å˜è°ƒä¸å˜é€Ÿ"</span>

<span class="comment">% ç¡®ä¿è¾“å…¥ä¸ºå®æ•°åˆ—å‘é‡</span>
y = real(y(:));
ly = length(y);

<span class="keyword">if</span> ly == lx
    y_interpolated = y;
<span class="keyword">else</span>
    <span class="comment">% TODO: ä½¿ç”¨interp1è¿›è¡Œçº¿æ€§æ’å€¼</span>
    x_old = 1:ly;
    x_new = linspace(1, ly, lx);
    y_interpolated = <span class="todo">?</span>;
<span class="keyword">end</span>

y_interpolated = y_interpolated(:);

<span class="comment">% TODO: è·å–æœ€å°å€¼å’Œæœ€å¤§å€¼</span>
min_val = <span class="todo">?</span>;
max_val = <span class="todo">?</span>;

<span class="comment">% TODO: å½’ä¸€åŒ–åˆ° [-1, 1] èŒƒå›´</span>
<span class="keyword">if</span> max_val > min_val
    y_interpolated = <span class="todo">?</span>;
<span class="keyword">else</span>
    y_interpolated = zeros(lx, 1);
<span class="keyword">end</span>
<span class="keyword">end</span></pre>
            </div>
        </div>

        <!-- æµ‹è¯•ç¤ºä¾‹ -->
        <div class="test-banner">
            <strong>ğŸ§ª å®Œæˆåæµ‹è¯•ï¼š</strong>
            <p style="margin: 10px 0;">å®Œæˆæ‰€æœ‰ä»£ç åï¼Œå¯ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æµ‹è¯•ï¼š</p>
            <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0;">
<span class="comment">% ç¤ºä¾‹1ï¼šæ–¹æ³•ä¸€å‡è°ƒ1.5å€ï¼ˆæ— å…±æŒ¯å³°ä¿®æ­£ï¼‰</span>
[y_out, fs] = ex0_all(<span class="string">'./audio/orig1.wav'</span>, 1.5, 1024, 256, 1, 0);
<span class="comment">% é¢„æœŸï¼šè¾“å‡ºé•¿åº¦ä¸åŸå§‹ç›¸åŒï¼ŒéŸ³è°ƒå‡é«˜</span>

<span class="comment">% ç¤ºä¾‹2ï¼šæ–¹æ³•ä¸€å‡è°ƒ1.5å€ï¼ˆå«å…±æŒ¯å³°ä¿®æ­£ï¼‰</span>
[y_out, fs] = ex0_all(<span class="string">'./audio/orig1.wav'</span>, 1.5, 1024, 256, 1, 1);
<span class="comment">% é¢„æœŸï¼šéŸ³è°ƒå‡é«˜ä½†éŸ³è‰²è‡ªç„¶ï¼Œä¸ä¼šåƒ"å°é»„äºº"</span></pre>
        </div>

    </div>

    <script>
        function toggleBlock(header) {
            const block = header.parentElement;
            block.classList.toggle('collapsed');
        }

        function expandAll() {
            document.querySelectorAll('.file-block').forEach(block => {
                block.classList.remove('collapsed');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.file-block').forEach(block => {
                block.classList.add('collapsed');
            });
        }

        function copyCode(event, codeId) {
            event.stopPropagation();
            const code = document.getElementById(codeId).innerText;
            navigator.clipboard.writeText(code).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = 'âœ“ å·²å¤åˆ¶';
                btn.style.background = '#38a169';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#48bb78';
                }, 2000);
            });
        }
    </script>
</body>
</html>
